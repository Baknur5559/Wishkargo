<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargo CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .client-group.hidden { display: none; }
        /* --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ò–ú–ê–¶–ò–ò --- */
    #loader {
        display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç */
    }
    .loader-spinner {
        border: 8px solid #f3f3f3; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
        border-top: 8px solid #4f46e5; /* –¶–≤–µ—Ç –∏–Ω–¥–∏–≥–æ, –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* --- –ö–û–ù–ï–¶ –°–¢–ò–õ–ï–ô --- */
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-[999]">
        <div class="loader-spinner"></div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">–í—Ö–æ–¥ –≤ CRM</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">–í–æ–π—Ç–∏</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="shift-screen" class="hidden min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">–û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É</h2>
        <form id="open-shift-form" class="space-y-4">
            <div>
                <label for="employee-select" class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</label>
                <select id="employee-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"></select>
            </div>
            <div>
                <label for="shift-exchange-rate" class="block text-sm font-medium text-gray-700">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å $</label>
                <input type="number" step="0.1" id="shift-exchange-rate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="shift-price-per-kg" class="block text-sm font-medium text-gray-700">–¶–µ–Ω–∞ –∑–∞ –∫–≥ ($)</label>
                <input type="number" step="0.1" id="shift-price-per-kg" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="starting-cash" class="block text-sm font-medium text-gray-700">–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–∞—Å—Å–µ (—Å–æ–º)</label>
                <input type="number" step="0.01" id="starting-cash" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <button type="button" id="cancel-open-shift" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm font-medium text-white bg-green-600 hover:bg-green-700">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
        </form>
    </div>
</div>

<div id="main-app" class="hidden">
    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Cargo CRM</h1>
            <div class="flex items-center gap-4">
                <div id="user-info" class="text-right"></div>
                <div id="shift-controls-container"></div>
                <button id="logout-btn" title="–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg text-sm">–í—ã–π—Ç–∏</button> 
            </div>
        </div>

        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" id="tabs"></nav>
        </div>

        <div id="tab-content" class="mt-6"></div>
        </div>
</div>

    <div id="issue-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-start justify-center z-50 overflow-y-auto pt-10"><div class="relative mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-md bg-white"></div></div>
    <div id="issued-history-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-start justify-center z-50 overflow-y-auto pt-10"><div class="relative mx-auto p-6 border w-full max-w-5xl shadow-lg rounded-md bg-white"></div></div>
    <div id="edit-client-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"></div></div>
    <div id="employee-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"></div></div>
    <div id="permissions-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-start justify-center z-50 overflow-y-auto pt-10"><div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white"></div></div>
    <div id="expense-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"></div></div>
    <div id="edit-order-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"></div></div>
    <div id="buyout-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-lg shadow-lg rounded-md bg-white"></div></div>
    <div id="shift-report-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50"><div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white"></div></div>
    
    <div id="whatsapp-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
       <div class="relative mx-auto p-8 border w-full max-w-lg shadow-lg rounded-md bg-white">
        </div>
    </div>

    <div id="client-tools-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
    <div class="relative mx-auto p-8 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-start">
            <h3 class="text-2xl font-bold mb-4">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <button onclick="document.getElementById('client-tools-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-2">–ò–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Excel</h4>
            <p class="text-sm text-gray-600 mb-4">–ö–æ–ª–æ–Ω–∫–∏: <strong>full_name</strong>, <strong>phone</strong>. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: <strong>client_code</strong>.</p>
            <input type="file" id="client-excel-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
            <button id="import-clients-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="client-import-results" class="mt-4 text-sm"></div>
        </div>

        <div class="bg-red-50 p-4 rounded-lg mt-6 border border-red-300">
            <h4 class="text-lg font-semibold mb-2 text-red-700">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
            <button id="wipe-clients-btn" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg">–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É</button>
            <p class="text-xs text-gray-500 mt-2">–í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï–• –∫–ª–∏–µ–Ω—Ç–æ–≤, –í–°–ï –∑–∞–∫–∞–∑—ã, –í–°–ï —Å–º–µ–Ω—ã –∏ –í–°–ï —Ä–∞—Å—Ö–æ–¥—ã.</p>
        </div>
    </div>
</div>

<script>

// =================================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò
// =================================================================
const API_URL = 'http://127.0.0.1:8000';
let sysConfig = {};
let clients = [];
let orders = [];
let orderStatuses = [];
let currentUser = {};
let activeShift = null;

const issueModal = document.getElementById('issue-modal');


// =================================================================
// –õ–û–ì–ò–ö–ê –í–•–û–î–ê –í –°–ò–°–¢–ï–ú–£
// =================================================================
const loginForm = document.getElementById('login-form');
loginForm.addEventListener('submit', async (e) => {
    showLoader();
    e.preventDefault();
    const password = document.getElementById('password').value;
    const loginError = document.getElementById('login-error');
    loginError.textContent = '';

    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }

        const data = await response.json();
        currentUser = data.employee;

        // --- –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–†–û–í–ï–†–ö–ê –†–û–õ–ò ---
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
            // –í–ª–∞–¥–µ–ª–µ—Ü –≤—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É, –±–µ–∑ —Å–º–µ–Ω
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            await initializeMainApp();
        } else {
            // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É
            await checkActiveShift();
        }

    } catch (error) {
        loginError.textContent = error.message;
    } finally {
        hideLoader(); // <--- –ò–ù–î–ò–ö–ê–¢–û–† –£–ñ–ï –ë–´–õ, –í–°–ï –•–û–†–û–®–û
    }
});

async function checkActiveShift() {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/shifts/active`);
        if (response.status === 404) {
            // –ê–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–∫—Ä—ã—Ç–∏—è
            await showOpenShiftScreen();
            return;
        }
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–º–µ–Ω—ã');

        const data = await response.json();
        const shift = data.shift;

        // –°–º–µ–Ω–∞ –µ—Å—Ç—å, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const confirmation = confirm(
            `–ù–∞–π–¥–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${shift.employee.full_name} (–Ω–∞—á–∞—Ç–∞ ${new Date(shift.start_time).toLocaleString()}).\n\n–í–æ–π—Ç–∏ –≤ –Ω–µ–µ?`
        );

        if (confirmation) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            await initializeMainApp();
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞
            return;
        }

    } catch (error) {
        alert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function showOpenShiftScreen() {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        document.getElementById('shift-exchange-rate').value = sysConfig.exchange_rate_usd;
        document.getElementById('shift-price-per-kg').value = sysConfig.price_per_kg_usd;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const empResponse = await fetch(`${API_URL}/employees`);
        const empData = await empResponse.json();
        const empSelect = document.getElementById('employee-select');
        empSelect.innerHTML = empData.employees
          .filter(e => e.is_active)
          .map(e => `<option value="${e.id}">${e.full_name}</option>`).join('');
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
            empSelect.value = currentUser.id;
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('shift-screen').classList.remove('hidden');

        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ–æ—Ä–º—É
        document.getElementById('open-shift-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            try {
                const payload = {
                    employee_id: parseInt(document.getElementById('employee-select').value),
                    starting_cash: parseFloat(document.getElementById('starting-cash').value),
                    exchange_rate_usd: parseFloat(document.getElementById('shift-exchange-rate').value),
                    price_per_kg_usd: parseFloat(document.getElementById('shift-price-per-kg').value)
                };

                const response = await fetch(`${API_URL}/shifts/open`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await handleApiError(response));

                // –í—Å–µ —Ö–æ—Ä–æ—à–æ, –≤—Ö–æ–¥–∏–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                document.getElementById('shift-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                await initializeMainApp();

            } catch(err) {
                alert(`–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${err.message}`);
            } finally {
                hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            }
        });

    } catch (error) {
        alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞ —Å–º–µ–Ω—ã: ${error.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }

    document.getElementById('cancel-open-shift').addEventListener('click', async () => {
        // –ü—Ä—è—á–µ–º —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        document.getElementById('shift-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (—Ç–∞–∫ –∫–∞–∫ —Å–º–µ–Ω–∞ –Ω–µ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞)
        await initializeMainApp();
    });
}


async function handleCloseShift() {
    const closingCash = prompt("–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –Ω–∞–ª–∏—á–Ω—ã—Ö –≤ –∫–∞—Å—Å–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã:");
    if (closingCash === null || closingCash === '') {
        alert("–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/shifts/close`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ closing_cash: parseFloat(closingCash) })
        });
        if (!response.ok) throw new Error(await handleApiError(response));

        alert("–°–º–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞!");
        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

    } catch (err) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function updateShiftButton() {
    const controlsDiv = document.getElementById('shift-controls-container');
    controlsDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/shifts/active`);

        if (!response.ok) {
            throw new Error('No active shift');
        }
        const data = await response.json();
        activeShift = data.shift;

        // –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç —Å–º–µ–Ω–∞ –û–¢–ö–†–´–¢–ê
        controlsDiv.innerHTML = `<button id="shift-action-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>`;
        document.getElementById('shift-action-btn').addEventListener('click', handleCloseShift);

    } catch (error) {
        activeShift = null;
        // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ—à–∏–±–∫—É (404), –∑–Ω–∞—á–∏—Ç —Å–º–µ–Ω–∞ –ó–ê–ö–†–´–¢–ê
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
            controlsDiv.innerHTML = `<button id="shift-action-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>`;
            // –¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
            document.getElementById('shift-action-btn').addEventListener('click', showOpenShiftScreen);
        }
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function initializeMainApp() {
    showLoader();
    try {
        document.getElementById('user-info').innerHTML = `
            <p class="font-semibold">${currentUser.full_name}</p>
            <p class="text-sm text-gray-600">${currentUser.role}</p>
        `;

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                location.reload();
            }
        });

        // --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–ù–ê–ß–ê–õ–ê –ì–†–£–ó–ò–ú –î–ê–ù–ù–´–ï ---
        const [configRes, statusesRes] = await Promise.all([
            fetch(`${API_URL}/config`),
            fetch(`${API_URL}/order_statuses`)
        ]);

        sysConfig = await configRes.json();
        const statusesData = await statusesRes.json();
        orderStatuses = statusesData.statuses;

        // --- –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò –†–ò–°–£–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° ---
        const tabsContainer = document.getElementById('tabs');
        let tabsHtml = '';
        let contentHtml = '';

        if (currentUser.permissions.includes('issue_orders')) { tabsHtml += '<button data-tab="issue" class="tab-btn">–í—ã–¥–∞—á–∞</button>'; contentHtml += '<div id="tab-issue" class="tab-pane"></div>'; }
        if (currentUser.permissions.includes('manage_orders')) { tabsHtml += '<button data-tab="orders" class="tab-btn">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>'; contentHtml += '<div id="tab-orders" class="tab-pane hidden"></div>'; }
        if (currentUser.permissions.includes('manage_clients')) { tabsHtml += '<button data-tab="clients" class="tab-btn">–ö–ª–∏–µ–Ω—Ç—ã</button>'; contentHtml += '<div id="tab-clients" class="tab-pane hidden"></div>'; }
        if (currentUser.permissions.includes('manage_employees')) { tabsHtml += '<button data-tab="employees" class="tab-btn">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>'; contentHtml += '<div id="tab-employees" class="tab-pane hidden"></div>'; }
        if (currentUser.permissions.includes('manage_roles')) { tabsHtml += '<button data-tab="roles" class="tab-btn">–î–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç—É–ø—ã</button>'; contentHtml += '<div id="tab-roles" class="tab-pane hidden"></div>'; }
        if (currentUser.permissions.includes('add_expense')) { tabsHtml += '<button data-tab="expenses" class="tab-btn">–†–∞—Å—Ö–æ–¥—ã</button>'; contentHtml += '<div id="tab-expenses" class="tab-pane hidden"></div>'; }
        if (currentUser.permissions.includes('view_shift_report')) {
            tabsHtml += '<button data-tab="report" class="tab-btn">–û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ</button>';
            contentHtml += '<div id="tab-report" class="tab-pane hidden"></div>';
        }
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') { tabsHtml += '<button data-tab="summary-report" class="tab-btn">–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</button>'; contentHtml += '<div id="tab-summary-report" class="tab-pane hidden"></div>'; }
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') { tabsHtml += '<button data-tab="buyout-report" class="tab-btn">–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø—É</button>'; contentHtml += '<div id="tab-buyout-report" class="tab-pane hidden"></div>'; }

        tabsContainer.innerHTML = tabsHtml.replaceAll('class="tab-btn"', 'class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700"');
        document.getElementById('tab-content').innerHTML = contentHtml;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if (document.getElementById('tab-clients')) renderClientsTab();
        if (document.getElementById('tab-orders')) renderOrdersTab();
        if (document.getElementById('tab-issue')) renderIssueTab();
        if (document.getElementById('tab-employees')) renderEmployeesTab();
        if (document.getElementById('tab-roles')) renderRolesTab();
        if (document.getElementById('tab-expenses')) renderExpensesTab();
        if (document.getElementById('tab-report')) renderShiftReportTab();
        if (document.getElementById('tab-summary-report')) renderSummaryReportTab();
        if (document.getElementById('tab-buyout-report')) renderBuyoutReportTab();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        await fetchAllOrdersData();
        if (document.getElementById('tab-clients')) await fetchAndRenderClients();
        if (document.getElementById('tab-issue')) await fetchAndRenderIssueList();

        const firstTab = tabsContainer.querySelector('.tab-btn');
        if(firstTab) firstTab.click();

        await updateShiftButton();

    } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:", e);
        alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞!");
        // —Ç—É—Ç –Ω–µ –ø—Ä—è—á–µ–º –ª–æ–∞–¥–µ—Ä, —Ç.–∫. –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª–æ–º–∞–Ω–æ
        return;
    } finally {
        hideLoader(); // <--- –ò–ù–î–ò–ö–ê–¢–û–† –£–ñ–ï –ë–´–õ, –í–°–ï –•–û–†–û–®–û
    }
}


// --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ì–†–£–ó–ß–ò–ö–û–ú ---
const showLoader = () => {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';
}

const hideLoader = () => {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';
}

// =================================================================
// –£–¢–ò–õ–ò–¢–´ –ò –û–ë–©–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
// =================================================================
async function handleApiError(response) {
    try {
        const errorJson = await response.json();
        return errorJson.detail || JSON.stringify(errorJson);
    } catch (e) {
        return `–°—Ç–∞—Ç—É—Å: ${response.status} - ${response.statusText}`;
    }
}

const readExcelFile = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            resolve(json);
        } catch (err) {
            reject(err);
        }
    };
    reader.onerror = error => reject(error);
    reader.readAsArrayBuffer(file);
});

document.getElementById('tabs').addEventListener('click', e => {
    if (!e.target.classList.contains('tab-btn')) return;
    const tabName = e.target.dataset.tab;
    document.getElementById('tabs').querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    e.target.classList.add('border-indigo-500', 'text-indigo-600');
    document.getElementById('tab-content').querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
    const activePane = document.getElementById(`tab-${tabName}`);
    if(activePane) {
        activePane.classList.remove('hidden');
    }
});

// =================================================================
// –ú–û–î–£–õ–¨: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–õ–û–ú
// =================================================================
function renderEmployeesTab() {
    const pane = document.getElementById('tab-employees');
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2>
                <button id="add-employee-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
            </div>
            <div id="employees-list" class="space-y-3"></div>
        </div>
    `;
    document.getElementById('add-employee-btn').addEventListener('click', () => openEmployeeModal());
    document.getElementById('employees-list').addEventListener('click', handleEmployeeActions);
    fetchAndRenderEmployees();
}

async function fetchAndRenderEmployees() {
    const listDiv = document.getElementById('employees-list');
    listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/employees`);
        const data = await response.json();
        listDiv.innerHTML = data.employees.map(emp => `
            <div class="p-3 ${emp.is_active ? 'bg-gray-50' : 'bg-red-50'} rounded-md flex justify-between items-center">
                <div>
                    <p class="font-bold">${emp.full_name} <span class="text-sm font-normal text-gray-500">(${emp.role.name})</span></p>
                    <p class="text-xs ${emp.is_active ? 'text-green-600' : 'text-red-600'}">${emp.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–£–≤–æ–ª–µ–Ω'}</p>
                </div>
                <div class="flex gap-2">
                    <button data-employee-id="${emp.id}" class="edit-employee-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button data-employee-id="${emp.id}" data-is-active="${emp.is_active}" class="toggle-status-btn text-sm ${emp.is_active ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'} px-3 py-1 rounded">
                        ${emp.is_active ? '–£–≤–æ–ª–∏—Ç—å' : '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'}
                    </button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function openEmployeeModal(employee = null) {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const employeeModal = document.getElementById('employee-modal');
        const modal = document.getElementById('employee-modal');
        const isEdit = employee !== null;
        const rolesResponse = await fetch(`${API_URL}/roles`);
        const rolesData = await rolesResponse.json();
        const rolesOptions = rolesData.roles.map(r => `<option value="${r.id}" ${isEdit && employee.role.id === r.id ? 'selected' : ''}>${r.name}</option>`).join('');

        modal.querySelector('.relative').innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞' : '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'}</h3>
                <button onclick="document.getElementById('employee-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
            </div>
            <form id="employee-form" data-employee-id="${isEdit ? employee.id : ''}" class="space-y-4">
                <div>
                    <label class="block text-sm">–§–ò–û</label>
                    <input type="text" name="full_name" class="mt-1 w-full p-2 border rounded" value="${isEdit ? employee.full_name : ''}" required>
                </div>
                <div>
                    <label class="block text-sm">–ü–∞—Ä–æ–ª—å</label>
                    <input type="text" name="password" class="mt-1 w-full p-2 border rounded" placeholder="${isEdit ? '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å' : ''}">
                </div>
                <div>
                    <label class="block text-sm">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select name="role_id" class="mt-1 w-full p-2 border rounded bg-white">${rolesOptions}</select>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="document.getElementById('employee-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        `;
        modal.classList.add('is-open');
        document.getElementById('employee-form').addEventListener('submit', handleSaveEmployee);
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞: ${error.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleSaveEmployee(e) {
    e.preventDefault();
    const form = e.target;
    const employeeId = form.dataset.employeeId;
    const isEdit = !!employeeId;
    const payload = {
        full_name: form.elements.full_name.value,
        role_id: parseInt(form.elements.role_id.value),
    };
    if (form.elements.password.value) {
        payload.password = form.elements.password.value;
    }

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/employees${isEdit ? `/${employeeId}` : ''}`, {
            method: isEdit ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        document.getElementById('employee-modal').classList.remove('is-open');
        await fetchAndRenderEmployees();
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleEmployeeActions(e) {
    const btn = e.target;
    const employeeId = btn.dataset.employeeId;

    if (btn.classList.contains('edit-employee-btn')) {
        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        try {
            const employees = (await (await fetch(`${API_URL}/employees`)).json()).employees;
            const employee = employees.find(emp => emp.id == employeeId);
            openEmployeeModal(employee); // –û—Ç–∫—Ä–æ–µ—Ç –º–æ–¥–∞–ª–∫—É –∏ —Å–≤–æ–π –ª–æ–∞–¥–µ—Ä
        } catch(err) {
             alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    }

    if (btn.classList.contains('toggle-status-btn')) {
        const isActive = btn.dataset.isActive === 'true';
        const action = isActive ? '–£–≤–æ–ª–∏—Ç—å' : '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action.toLowerCase()} —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?`)) {
            showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            try {
                const response = await fetch(`${API_URL}/employees/${employeeId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ is_active: !isActive })
                });
                if (!response.ok) throw new Error(await handleApiError(response));
                await fetchAndRenderEmployees();
            } catch (err) {
                alert(`–û—à–∏–±–∫–∞: ${err.message}`);
            } finally {
                hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            }
        }
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–û–õ–ñ–ù–û–°–¢–Ø–ú–ò –ò –î–û–°–¢–£–ü–ê–ú–ò
// =================================================================

function renderRolesTab() {
    const pane = document.getElementById('tab-roles');
    pane.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</h2>
                    <form id="add-role-form" class="space-y-3">
                        <input type="text" id="new-role-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏" class="w-full p-2 border rounded" required>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg">–°–æ–∑–¥–∞—Ç—å</button>
                    </form>
                </div>
            </div>
            <div class="md:col-span-2">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</h2>
                    <div id="roles-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('add-role-form').addEventListener('submit', handleAddRole);
    document.getElementById('roles-list').addEventListener('click', handleRolesActions);
    fetchAndRenderRoles();
}

async function fetchAndRenderRoles() {
    const listDiv = document.getElementById('roles-list');
    listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/roles`);
        const data = await response.json();
        listDiv.innerHTML = data.roles.map(role => `
            <div class="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                <p class="font-bold">${role.name}</p>
                <div class="flex gap-2">
                    <button data-role-id="${role.id}" data-role-name="${role.name}" class="permissions-btn text-sm bg-blue-200 text-blue-800 px-3 py-1 rounded">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø—ã</button>
                    ${role.name !== '–í–ª–∞–¥–µ–ª–µ—Ü' ? `<button data-role-id="${role.id}" class="delete-role-btn text-sm bg-red-200 text-red-800 px-3 py-1 rounded">&times;</button>` : ''}
                </div>
            </div>
        `).join('');
    } catch (e) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleAddRole(e) {
    e.preventDefault();
    const roleName = document.getElementById('new-role-name').value;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/roles`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: roleName })
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        e.target.reset();
        await fetchAndRenderRoles();
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleRolesActions(e) {
    const btn = e.target;
    const roleId = btn.dataset.roleId;
    if (btn.classList.contains('permissions-btn')) {
        const roleName = btn.dataset.roleName;
        openPermissionsModal(roleId, roleName);
    }
    if (btn.classList.contains('delete-role-btn')) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å?')) {
            showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            try {
                const response = await fetch(`${API_URL}/roles/${roleId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(await handleApiError(response));
                await fetchAndRenderRoles();
            } catch(err) {
                alert(`–û—à–∏–±–∫–∞: ${err.message}`);
            } finally {
                hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            }
        }
    }
}

async function openPermissionsModal(roleId, roleName) {
    const permissionsModal = document.getElementById('permissions-modal');
    const modal = document.getElementById('permissions-modal').querySelector('.relative');
    modal.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–æ–≤...</p>';
    document.getElementById('permissions-modal').classList.add('is-open');
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    try {
        const [permsRes, rolePermsRes] = await Promise.all([
            fetch(`${API_URL}/permissions`),
            fetch(`${API_URL}/roles/${roleId}/permissions`)
        ]);
        const allPermissions = (await permsRes.json()).permissions;
        const rolePermissionIds = new Set((await rolePermsRes.json()).permission_ids);

        const permissionsHtml = allPermissions.map(p => `
            <div class="flex items-center">
                <input id="perm-${p.id}" type="checkbox" value="${p.id}" class="h-4 w-4 permission-checkbox" ${rolePermissionIds.has(p.id) ? 'checked' : ''}>
                <label for="perm-${p.id}" class="ml-3 block text-sm text-gray-900">${p.description}</label>
            </div>
        `).join('');

        modal.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–æ–≤ –¥–ª—è: <span class="text-indigo-600">${roleName}</span></h3>
                <button onclick="document.getElementById('permissions-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
            </div>
            <form id="permissions-form" data-role-id="${roleId}">
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">${permissionsHtml}</div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="document.getElementById('permissions-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        `;
        document.getElementById('permissions-form').addEventListener('submit', handleSavePermissions);
    } catch (err) {
        modal.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleSavePermissions(e) {
    e.preventDefault();
    const form = e.target;
    const roleId = form.dataset.roleId;
    const selectedIds = Array.from(form.querySelectorAll('.permission-checkbox:checked')).map(cb => parseInt(cb.value));

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/roles/${roleId}/permissions`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ permission_ids: selectedIds })
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        alert('–î–æ—Å—Ç—É–ø—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
        document.getElementById('permissions-modal').classList.remove('is-open');
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –†–ê–°–•–û–î–´
// =================================================================

function renderExpensesTab() {
    const today = new Date().toISOString().split('T')[0];
    const pane = document.getElementById('tab-expenses');
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold">–£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
                <button id="add-expense-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
            </div>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4">
                <div>
                    <label for="expense-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="expense-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="expense-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="expense-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <button id="filter-expenses-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
            <div class="mb-4">
                <input type="search" id="expenses-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É, —Å—É–º–º–µ, –ø—Ä–∏–º–µ—á–∞–Ω–∏—é..." class="w-full p-2 border rounded-lg">
            </div>
            <div id="expenses-list" class="space-y-3"></div>
        </div>
    `;
    document.getElementById('add-expense-btn').addEventListener('click', () => openExpenseModal());
    document.getElementById('filter-expenses-btn').addEventListener('click', fetchAndRenderExpenses);
    document.getElementById('expenses-list').addEventListener('click', handleExpenseActions);
    document.getElementById('expenses-search-input').addEventListener('input', handleExpensesSearch);
    fetchAndRenderExpenses(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
}

async function fetchAndRenderExpenses() {
    const listDiv = document.getElementById('expenses-list');
    listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    const startDate = document.getElementById('expense-start-date').value;
    const endDate = document.getElementById('expense-end-date').value;

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/expenses?start_date=${startDate}&end_date=${endDate}`);
        if (!response.ok) throw new Error(await handleApiError(response));
        const data = await response.json();

        if (data.expenses.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç.</p>';
            return;
        }

        listDiv.innerHTML = data.expenses.map(exp => `
            <div class="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                <div>
                    <p class="font-bold">${exp.expense_type.name} - <span class="text-red-600">${exp.amount.toFixed(2)} —Å–æ–º</span></p>
                    <p class="text-sm text-gray-600">${exp.notes || '–ë–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è'}</p>
                    <p class="text-xs text-gray-400">
                        ${new Date(exp.created_at).toLocaleString()} | ${exp.shift.employee.full_name}
                    </p>
                </div>
                <button data-expense-id="${exp.id}" class="edit-expense-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                    –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        `).join('');
    } catch (e) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function openExpenseModal(expense = null) {
    if (!activeShift) {
        alert('–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞! –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥.');
        return;
    }
    const expenseModal = document.getElementById('expense-modal');
    const modal = document.getElementById('expense-modal').querySelector('.relative');
    const isEdit = expense !== null;

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const typesResponse = await fetch(`${API_URL}/expense_types`);
        const typesData = await typesResponse.json();
        const typesOptions = typesData.expense_types
            .filter(t => currentUser.role !== '–í–ª–∞–¥–µ–ª–µ—Ü' ? (t.name !== '–ó–∞—Ä–ø–ª–∞—Ç–∞' && t.name !== '–ê–≤–∞–Ω—Å') : true)
            .map(t => `<option value="${t.id}" ${isEdit && expense.expense_type_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

        modal.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥'}</h3>
                <button onclick="document.getElementById('expense-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
            </div>
            <form id="expense-form" data-expense-id="${isEdit ? expense.id : ''}" class="space-y-4">
                <div>
                    <label class="block text-sm">–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞</label>
                    <select name="expense_type_id" class="mt-1 w-full p-2 border rounded bg-white" required>${typesOptions}</select>
                </div>
                <div>
                    <label class="block text-sm">–°—É–º–º–∞ (—Å–æ–º)</label>
                    <input type="number" step="0.01" name="amount" class="mt-1 w-full p-2 border rounded" value="${isEdit ? expense.amount : ''}" required>
                </div>
                <div>
                    <label class="block text-sm">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                    <textarea name="notes" class="mt-1 w-full p-2 border rounded">${isEdit ? expense.notes || '' : ''}</textarea>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="document.getElementById('expense-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        `;
        document.getElementById('expense-modal').classList.add('is-open');
        document.getElementById('expense-form').addEventListener('submit', handleSaveExpense);
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleSaveExpense(e) {
    e.preventDefault();
    const form = e.target;
    const expenseId = form.dataset.expenseId;
    const isEdit = !!expenseId;
    const payload = {
        expense_type_id: parseInt(form.elements.expense_type_id.value),
        amount: parseFloat(form.elements.amount.value),
        notes: form.elements.notes.value
    };

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/expenses${isEdit ? `/${expenseId}` : ''}`, {
            method: isEdit ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        document.getElementById('expense-modal').classList.remove('is-open');
        await fetchAndRenderExpenses();
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleExpenseActions(e) {
    if (e.target.classList.contains('edit-expense-btn')) {
        const expenseId = e.target.dataset.expenseId;
        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        try {
            const startDate = document.getElementById('expense-start-date').value;
            const endDate = document.getElementById('expense-end-date').value;
            const response = await fetch(`${API_URL}/expenses?start_date=${startDate}&end_date=${endDate}`);
            const data = (await response.json()).expenses;
            const expense = data.find(exp => exp.id == expenseId);

            const expenseDate = new Date(expense.created_at).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];

            if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' || expenseDate === today) {
                openExpenseModal(expense);
            } else {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø—Ä–æ—à–ª—ã–µ –¥–∞—Ç—ã.');
            }
        } catch (err) {
            alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –ö–õ–ò–ï–ù–¢–´
// =================================================================

function renderClientsTab() {
    const pane = document.getElementById('tab-clients');
    if (!pane) return;

    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                <div class="flex items-center gap-4">
                    <button id="client-tools-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
                    <button id="add-client-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                </div>
            </div>
            <div class="mb-4">
                <input type="search" id="clients-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
            </div>
            <div id="clients-list" class="space-y-3"></div>
        </div>
    `;

    document.getElementById('add-client-btn').addEventListener('click', () => openClientModal());
    document.getElementById('clients-search-input').addEventListener('input', handleClientsSearch);
    document.getElementById('clients-list').addEventListener('click', handleClientActions);

    document.getElementById('client-tools-btn').addEventListener('click', () => {
        document.getElementById('client-tools-modal').classList.add('is-open');
    });

    document.getElementById('import-clients-btn').addEventListener('click', handleClientExcelImport);
    document.getElementById('wipe-clients-btn').addEventListener('click', handleWipeClients);

    fetchAndRenderClients();
}

function openClientModal(client = null) {
    const isEdit = client !== null;
    const editClientModal = document.getElementById('edit-client-modal');
    const modalContent = editClientModal.querySelector('.relative');

    modalContent.innerHTML = `
        <div class="flex justify-between items-start">
            <h3 class="text-2xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞'}</h3>
            <button onclick="document.getElementById('edit-client-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
        </div>
        <form id="client-form-inner" class="space-y-4">
            <div>
                <label class="block text-sm">–§–ò–û</label>
                <input type="text" id="client-full_name" value="${isEdit ? client.full_name : ''}" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div>
                <label class="block text-sm">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="client-phone" value="${isEdit ? client.phone : ''}" placeholder="996..." class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-sm">–ü—Ä–µ—Ñ–∏–∫—Å</label>
                    <input type="text" id="client-prefix" value="${isEdit ? (client.client_code_prefix || 'WK') : 'WK'}" class="mt-1 w-full p-2 border rounded">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm">–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="number" id="client-code" value="${isEdit ? (client.client_code_num || '') : ''}" class="mt-1 w-full p-2 border rounded" ${isEdit ? '' : 'disabled title="–ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"'}>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button type="button" onclick="document.getElementById('edit-client-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;
    editClientModal.classList.add('is-open');

    document.getElementById('client-form-inner').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            full_name: document.getElementById('client-full_name').value,
            phone: document.getElementById('client-phone').value,
            client_code_prefix: document.getElementById('client-prefix').value,
            client_code_num: isEdit ? (parseInt(document.getElementById('client-code').value) || null) : null
        };

        const url = isEdit ? `${API_URL}/clients/${client.id}` : `${API_URL}/register_client`;
        const method = isEdit ? 'PATCH' : 'POST';

        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        try {
            const r = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(isEdit ? payload : { full_name: payload.full_name, phone: payload.phone })
            });
            if (!r.ok) throw new Error(await handleApiError(r));

            alert(isEdit ? '–ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
            editClientModal.classList.remove('is-open');
            await fetchAndRenderClients(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } catch (err) {
            alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    });
}

async function fetchAndRenderClients() {
    showLoader();
    const listDiv = document.getElementById('clients-list');
    if (listDiv) {
        listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    }
    try {
        const r = await fetch(`${API_URL}/clients`);
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        clients = j.clients;
        if (listDiv) {
            listDiv.innerHTML = '';
            if (!clients || clients.length === 0) {
                listDiv.innerHTML = '<p>–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.</p>';
            } else {
                clients.forEach(c => {
                    const d = document.createElement('div');
                    d.className = 'p-3 bg-gray-50 rounded-md flex justify-between items-center';
                    d.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold">${c.full_name} (${c.client_code_prefix}${c.client_code_num})</p>
                            <p class="text-sm text-gray-600">${c.phone}</p>
                        </div>
                        <div class="flex-shrink-0 flex gap-2">
                            <button data-client-id="${c.id}" class="edit-client-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–†–µ–¥–∞–∫—Ç.</button>
                            <button data-client-id="${c.id}" class="delete-client-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    listDiv.appendChild(d);
                });
            }
        }
    } catch (e) {
        if (listDiv) {
            listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
        }
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤:", e);
    } finally {
        hideLoader();
    }
}

async function handleAddClient(e) {
    e.preventDefault();
    const d = {
        full_name: document.getElementById('full_name').value,
        phone: document.getElementById('phone').value
    };
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/register_client`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(d)
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(`–£—Å–ø–µ—Ö! ${j.message}`);
        e.target.reset();
        await fetchAndRenderClients();
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:", err);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

function handleClientActions(e) {
    const t = e.target;
    const editButton = t.closest('.edit-client-btn');
    const deleteButton = t.closest('.delete-client-btn');

    if (editButton) {
        const cId = editButton.dataset.clientId;
        const editClientModal = document.getElementById('edit-client-modal');
        const modalContent = editClientModal.querySelector('.relative');
        const c = clients.find(cl => cl.id == cId);
        if (!c) return;

        const telegramStatus = c.telegram_chat_id ?
            `<p class="text-sm text-green-600 font-semibold text-center">‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∞–Ω</p>` :
            `<p class="text-sm text-gray-500 text-center">Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω (–∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º –ø—Ä–∏–≤—è–∑–∞—Ç—å –µ–≥–æ –≤ –±–æ—Ç–µ)</p>`;

        modalContent.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
                <button onclick="document.getElementById('edit-client-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-client-form-inner">
                <input type="hidden" id="edit-client-id" value="${c.id}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm">–§–ò–û</label>
                        <input type="text" id="edit-full_name" value="${c.full_name}" class="mt-1 w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" id="edit-phone" value="${c.phone}" class="mt-1 w-full p-2 border rounded">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-sm">–ü—Ä–µ—Ñ–∏–∫—Å</label>
                            <input type="text" id="edit-prefix" value="${c.client_code_prefix || ''}" class="mt-1 w-full p-2 border rounded">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm">–ö–æ–¥</label>
                            <input type="number" id="edit-code" value="${c.client_code_num || ''}" class="mt-1 w-full p-2 border rounded">
                        </div>
                    </div>
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <button type="button" id="generate-lk-link-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">üìã –°—Å—ã–ª–∫–∞ –¥–ª—è –õ–∏—á–Ω–æ–≥–æ –ö–∞–±–∏–Ω–µ—Ç–∞</button>
                        ${telegramStatus}
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="document.getElementById('edit-client-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        `;
        editClientModal.classList.add('is-open');

        document.getElementById('generate-lk-link-btn').addEventListener('click', async () => {
            showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            try {
                const response = await fetch(`${API_URL}/clients/${c.id}/generate_lk_link`, { method: 'POST' });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –õ–ö.');
                const data = await response.json();
                prompt("–°—Å—ã–ª–∫–∞ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞:", data.link);
            } catch (err) {
                alert(`–û—à–∏–±–∫–∞: ${err.message}`);
            } finally {
                hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            }
        });

        document.getElementById('edit-client-form-inner').addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const clientId = document.getElementById('edit-client-id').value;
            const data = {
                full_name: document.getElementById('edit-full_name').value,
                phone: document.getElementById('edit-phone').value,
                client_code_prefix: document.getElementById('edit-prefix').value,
                client_code_num: parseInt(document.getElementById('edit-code').value) || null
            };
            showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            try {
                const r = await fetch(`${API_URL}/clients/${clientId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) throw new Error(await handleApiError(r));
                alert('–ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                editClientModal.classList.remove('is-open');
                await fetchAndRenderClients();
            } catch (err) {
                alert(`–û—à–∏–±–∫–∞: ${err.message}`);
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:", err);
            } finally {
                hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
            }
        });
    }

    if (deleteButton) {
        const cId = deleteButton.dataset.clientId;
        const c = clients.find(cl => cl.id == cId);
        if (!c) return;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å "${c.full_name}"?`)) {
            deleteClient(cId);
        }
    }
}

async function deleteClient(cId) {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/clients/${cId}`, { method: 'DELETE' });
        if (!r.ok) throw new Error(await handleApiError(r));
        alert('–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!');
        await fetchAndRenderClients();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞: ${e.message}`);
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:", e);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleWipeClients() {
    const p = prompt("–ü–ê–†–û–õ–¨ –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø –í–°–ï–• –î–ê–ù–ù–´–•:");
    if (p === null) return;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/clients/wipe_all`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: p })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(j.message);
        await fetchAndRenderClients();
        await fetchAllOrdersData();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞: ${e.message}`);
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã:", e);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleClientExcelImport(e) {
    const i = document.getElementById('client-excel-input');
    const rDiv = document.getElementById('client-import-results');
    if (i.files.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª.');
        return;
    }
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const json = await readExcelFile(i.files[0]);
        if (json.length === 0 || !json[0].full_name || !json[0].phone) {
            alert('–û—à–∏–±–∫–∞! –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏ "full_name" –∏ "phone".');
            return;
        }
        rDiv.innerHTML = `<p class="text-blue-600">–ò–¥–µ—Ç –∏–º–ø–æ—Ä—Ç ${json.length} –∫–ª–∏–µ–Ω—Ç–æ–≤...</p>`;
        const dataToSend = json.map(row => ({...row, phone: String(row.phone), client_code: row.client_code ? String(row.client_code) : undefined }));
        const res = await fetch(`${API_URL}/clients/bulk_import`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        if (!res.ok) throw new Error(await handleApiError(res));
        const j = await res.json();
        let msg = `<p class="text-green-600"><strong>–£—Å–ø–µ—à–Ω–æ: ${j.created_clients}</strong></p>`;
        if (j.errors && j.errors.length > 0) {
            msg += `<p class="text-red-600 mt-2"><strong>–û—à–∏–±–∫–∏ (${j.errors.length}):</strong></p><ul class="list-disc list-inside">${j.errors.map(er => `<li>${er}</li>`).join('')}</ul>`;
        }
        rDiv.innerHTML = msg;
        await fetchAndRenderClients();
    } catch (error) {
        rDiv.innerHTML = `<p class="text-red-500">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}</p>`;
        console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤:", error);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –ó–ê–ö–ê–ó–´
// =================================================================

const renderOrdersTab = () => {
    const pane = document.getElementById('tab-orders');
    if (!pane) return;

    pane.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                    <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</h2>
                    <form id="add-order-form" class="space-y-4">
                        <div class="relative">
                            <label class="block text-sm">–ö–ª–∏–µ–Ω—Ç (–ø–æ–∏—Å–∫)</label>
                            <input type="text" id="client-search-input" autocomplete="off" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." class="mt-1 w-full p-2 border rounded">
                            <input type="hidden" id="selected-client-id">
                            <div id="client-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-lg z-20"></div>
                        </div>
                        <div>
                            <label class="block text-sm">–¢—Ä–µ–∫-–∫–æ–¥</label>
                            <input type="text" id="track_code" class="mt-1 w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
                            <select id="purchase_type" required class="mt-1 w-full p-2 border rounded bg-white">
                                <option value="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                                <option value="–í—ã–∫—É–ø">–í—ã–∫—É–ø</option>
                            </select>
                        </div>
                        <div id="buyout-fields" class="hidden space-y-4 border-t pt-4">
                            <div>
                                <label class="block text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ (CNY)</label>
                                <input type="number" step="any" id="buyout_item_cost_cny" class="mt-1 w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm">–ö—É—Ä—Å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (—Å–æ–º/—é–∞–Ω—å)</label>
                                <input type="number" step="any" id="buyout_rate_for_client" class="mt-1 w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm">–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã–∫—É–ø (%)</label>
                                <input type="number" step="1" id="buyout_commission_percent" value="10" class="mt-1 w-full p-2 border rounded">
                            </div>
                            <div class="p-3 bg-indigo-50 rounded-md text-center">
                                <p class="text-sm text-gray-600">–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</p>
                                <p id="buyout-final-price-display" class="text-xl font-bold text-indigo-700">0.00 —Å–æ–º</p>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded">–°–æ–∑–¥–∞—Ç—å</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                    <h2 class="text-xl font-semibold mb-4">–ò–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤</h2>
                    <p class="text-sm text-gray-600 mb-2">–ö–æ–ª–æ–Ω–∫–∏: <strong>track_code</strong> –∏ (<strong>client_code</strong> –∏–ª–∏ <strong>phone</strong>). –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: <strong>comment</strong>.</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium">–î–∞—Ç–∞ –ø–∞—Ä—Ç–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input type="date" id="import-party-date" class="mt-1 w-full p-2 border rounded">
                        </div>
                    </div>
                    <input type="file" id="order-excel-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mt-4"/>
                    <button id="import-orders-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg">–ò–º–ø–æ—Ä—Ç</button>
                    <div id="order-import-results" class="mt-4 text-sm"></div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div id="action-header" class="sticky top-0 bg-white py-2 mb-4 border-b -mx-6 px-6 flex justify-between items-center z-10">
                    <div class="flex items-center gap-2">
                        <div class="p-2 bg-gray-100 rounded-md shadow-sm">
                            <button id="toggle-select-mode-btn" class="font-bold text-indigo-600 hover:text-indigo-800">‚úÖ –í—ã–±—Ä–∞—Ç—å</button>
                        </div>
                        <div class="p-2 bg-gray-100 rounded-md shadow-sm relative">
                            <button id="toggle-party-filter-btn" class="font-bold text-indigo-600 hover:text-indigo-800">üó≥Ô∏è –ü–∞—Ä—Ç–∏–∏</button>
                            <div id="party-filter-container" class="hidden absolute top-full mt-2 bg-white border rounded-lg shadow-lg p-4 w-60">
                                <p class="font-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏–∏:</p>
                                <div id="party-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                                <button id="apply-party-filter" class="w-full mt-3 bg-indigo-600 text-white text-sm py-1 rounded">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="p-2 bg-gray-100 rounded-md shadow-sm relative">
                            <button id="toggle-status-filter-btn" class="font-bold text-indigo-600 hover:text-indigo-800">üü¢ –°—Ç–∞—Ç—É—Å—ã</button>
                            <div id="status-filter-container" class="hidden absolute top-full mt-2 bg-white border rounded-lg shadow-lg p-4 w-60">
                                <p class="font-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å—ã:</p>
                                <div id="status-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                                <button id="apply-status-filter" class="w-full mt-3 bg-indigo-600 text-white text-sm py-1 rounded">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="p-2 bg-gray-100 rounded-md shadow-sm">
                           <button id="export-orders-btn" class="font-bold text-green-600 hover:text-green-800">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                    <button id="refresh-orders" title="–û–±–Ω–æ–≤–∏—Ç—å" class="text-2xl">&circlearrowright;</button>
                </div>
                <div class="mb-4">
                    <input type="search" id="orders-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç–µ–ª–µ—Ñ–æ–Ω—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
                </div>
                <div id="bulk-action-bar" class="hidden p-3 bg-indigo-50 rounded-lg mb-4 space-y-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <span id="selected-count" class="font-bold"></span>
                        <div class="flex items-center gap-2 border-l pl-3">
                            <select id="bulk-status-select" class="rounded-md border-gray-300 p-2 text-sm"></select>
                            <button id="bulk-update-status-btn" class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg text-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                        </div>
                        <div class="flex items-center gap-2 border-l pl-3">
                            <input type="date" id="bulk-party-date-input" class="p-2 border rounded text-sm">
                            <button id="bulk-update-date-btn" class="bg-orange-500 text-white font-bold py-2 px-3 rounded-lg text-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É</button>
                        </div>
                        <button id="bulk-buyout-btn" class="hidden bg-purple-600 text-white font-bold py-2 px-3 rounded-lg text-sm">–í—ã–∫—É–ø–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ</button>
                    </div>
                    <div class="border-t pt-2">
                        <button id="bulk-delete-btn" class="bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-sm">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                    </div>
                </div>
                <div id="select-all-container" class="hidden flex items-center p-2 border-b">
                    <input type="checkbox" id="select-all-orders" class="h-4 w-4 rounded">
                    <label for="select-all-orders" class="ml-3 block text-sm font-bold text-gray-700">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</label>
                </div>
                <div id="orders-list" class="space-y-4"></div>
            </div>
        </div>
    `;

    document.getElementById('add-order-form').addEventListener('submit', handleAddOrder);
    document.getElementById('refresh-orders').addEventListener('click', fetchAndRenderOrders);

    document.getElementById('orders-list').addEventListener('click', handleOrderActions);
    document.getElementById('orders-list').addEventListener('change', handleOrderCheckboxChange);
    document.getElementById('import-orders-btn').addEventListener('click', handleOrderExcelImport);
    document.getElementById('client-search-input').addEventListener('input', (e) => {
        const resultsDiv = document.getElementById('client-search-results');
        searchClients(e.target.value, (client) => {
            e.target.value = `${client.full_name} (${client.client_code_prefix}${client.client_code_num})`;
            document.getElementById('selected-client-id').value = client.id;
            resultsDiv.innerHTML = '';
        }, resultsDiv);
    });
    document.getElementById('toggle-select-mode-btn').addEventListener('click', toggleSelectMode);

    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('toggle-party-filter-btn').addEventListener('click', togglePartyFilter);
    document.getElementById('toggle-status-filter-btn').addEventListener('click', toggleStatusFilter);
    document.getElementById('apply-party-filter').addEventListener('click', applyAllFilters);
    document.getElementById('apply-status-filter').addEventListener('click', applyAllFilters);

    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    document.getElementById('select-all-orders').addEventListener('change', handleSelectAllOrders);
    document.getElementById('bulk-update-status-btn').addEventListener('click', handleBulkUpdateStatus);
    document.getElementById('bulk-update-date-btn').addEventListener('click', handleBulkUpdatePartyDate);
    document.getElementById('bulk-delete-btn').addEventListener('click', handleBulkDelete);
    document.getElementById('bulk-buyout-btn').addEventListener('click', openBuyoutModal);
    document.getElementById('export-orders-btn').addEventListener('click', handleExportOrders);
    document.getElementById('orders-search-input').addEventListener('input', handleOrdersSearch);

    // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã–∫—É–ø–∞
    const buyoutInputs = ['buyout_item_cost_cny', 'buyout_rate_for_client', 'buyout_commission_percent'];
    buyoutInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => {
                const cost = parseFloat(document.getElementById('buyout_item_cost_cny').value) || 0;
                const rate = parseFloat(document.getElementById('buyout_rate_for_client').value) || 0;
                const commission = parseFloat(document.getElementById('buyout_commission_percent').value) || 0;
                const commissionAmount = cost * (commission / 100);
                const finalPrice = (cost + commissionAmount) * rate;
                document.getElementById('buyout-final-price-display').textContent = `${finalPrice.toFixed(2)} —Å–æ–º`;
            });
        }
    });

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –¥–ª—è –≤—ã–∫—É–ø–∞
    document.getElementById('purchase_type').addEventListener('change', (e) => {
        const buyoutFields = document.getElementById('buyout-fields');
        if (e.target.value === '–í—ã–∫—É–ø') {
            buyoutFields.classList.remove('hidden');
        } else {
            buyoutFields.classList.add('hidden');
        }
    });
};

async function fetchAndRenderOrders() {
    const listDiv = document.getElementById('orders-list');
    listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    const selectedParties = Array.from(document.querySelectorAll('#party-list input:checked')).map(cb => cb.value);
    const selectedStatuses = Array.from(document.querySelectorAll('#status-list input:checked')).map(cb => cb.value);

    const params = new URLSearchParams();
    selectedParties.forEach(date => params.append('party_dates', date));

    const isSearching = document.getElementById('orders-search-input')?.value;
    if (selectedStatuses.length > 0) {
        selectedStatuses.forEach(status => params.append('statuses', status));
    } else if (!isSearching) {
        orderStatuses.filter(s => s !== '–í—ã–¥–∞–Ω').forEach(status => params.append('statuses', status));
    }

    const url = `${API_URL}/orders?${params.toString()}`;

    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        orders = j.orders;
        const groupedOrders = orders.reduce((acc, order) => {
            const clientId = order.client.id;
            if (!acc[clientId]) {
                acc[clientId] = {
                    client: order.client,
                    orders: [],
                    party_date: order.party_date
                };
            }
            acc[clientId].orders.push(order);
            return acc;
        }, {});

        listDiv.innerHTML = '';
        if (Object.keys(groupedOrders).length === 0) {
            listDiv.innerHTML = '<p>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
            return;
        }
        for (const clientId in groupedOrders) {
            const group = groupedOrders[clientId];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'p-4 bg-gray-50 rounded-lg shadow-sm';
            let trackListHtml = group.orders.map(o => `
                <li class="flex items-center justify-between py-1">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" data-order-id="${o.id}" class="order-checkbox h-4 w-4 hidden">
                        <div>
                            <span>${o.track_code}</span> <span class="text-xs text-gray-500">(${o.status})</span>
                            ${o.comment ? `<p class="text-xs text-blue-600 font-medium">${o.comment}</p>` : ''}
                        </div>
                    </div>
                    <button data-order-id="${o.id}" class="edit-order-btn text-lg p-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑">‚úèÔ∏è</button>
                </li>
            `).join('');
            groupDiv.innerHTML = `
                <div class="flex justify-between items-start border-b pb-2 mb-2">
                    <div>
                        <h3 class="font-bold text-lg">${group.client.full_name}</h3>
                        <p class="text-sm text-gray-600">${group.client.client_code_prefix}${group.client.client_code_num || ''} - ${group.client.phone}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-sm font-semibold">–ü–∞—Ä—Ç–∏—è: ${group.party_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <button class="whatsapp-btn text-2xl" data-client-id="${group.client.id}" title="–ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ WhatsApp">üí¨</button>
                    </div>
                </div>
                <ul class="list-disc list-inside space-y-1">${trackListHtml}</ul>
            `;
            listDiv.appendChild(groupDiv);
        }
        document.getElementById('select-all-container').classList.add('hidden');
        document.getElementById('bulk-action-bar').classList.add('hidden');
    } catch (e) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:", e);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleAddOrder(e) {
    e.preventDefault();
    const cId = document.getElementById('selected-client-id').value;
    if (!cId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø–æ–∏—Å–∫–∞!');
        return;
    }

    const payload = {
        client_id: parseInt(cId),
        track_code: document.getElementById('track_code').value,
        purchase_type: document.getElementById('purchase_type').value
    };

    if (payload.purchase_type === '–í—ã–∫—É–ø') {
        payload.buyout_item_cost_cny = parseFloat(document.getElementById('buyout_item_cost_cny').value) || null;
        payload.buyout_rate_for_client = parseFloat(document.getElementById('buyout_rate_for_client').value) || null;
        payload.buyout_commission_percent = parseFloat(document.getElementById('buyout_commission_percent').value);
    }

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/clients/${cId}/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(await handleApiError(r));

        alert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!');
        document.getElementById('add-order-form').reset();
        document.getElementById('buyout-fields').classList.add('hidden');

        await fetchAllOrdersData();
        await fetchAndRenderOrders();
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:", err);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

function handleOrderActions(e) {
    if (e.target.classList.contains('update-status-btn')) {
        const b = e.target;
        const oId = b.dataset.orderId;
        const nS = document.querySelector(`.status-select[data-order-id='${oId}']`).value;
        updateOrderStatus(oId, nS, b);
    }
    if (e.target.closest('.edit-order-btn')) {
        const orderId = e.target.closest('.edit-order-btn').dataset.orderId;
        openEditOrderModal(orderId);
    }
    if (e.target.closest('.whatsapp-btn')) {
        const clientId = e.target.closest('.whatsapp-btn').dataset.clientId;
        openWhatsAppModal(clientId);
    }
}

async function updateOrderStatus(oId, nS, b) {
    b.textContent = '...';
    b.disabled = true;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/${oId}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: nS })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", err);
    } finally {
        b.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        b.disabled = false;
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

function toggleSelectMode() {
    document.querySelectorAll('.order-checkbox').forEach(cb => cb.classList.toggle('hidden'));
    document.getElementById('select-all-container').classList.toggle('hidden');
    if (document.querySelectorAll('.order-checkbox:not(.hidden)').length === 0) {
        document.getElementById('bulk-action-bar').classList.add('hidden');
        document.getElementById('select-all-orders').checked = false;
    }
}

async function togglePartyFilter() {
    const container = document.getElementById('party-filter-container');
    if (!container.classList.contains('hidden')) {
        container.classList.add('hidden');
        return;
    }
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/parties`);
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        const j = await r.json();
        const listDiv = document.getElementById('party-list');
        listDiv.innerHTML = '';
        j.parties.forEach(p => {
            listDiv.innerHTML += `
                <div>
                    <input type="checkbox" id="party-${p}" value="${p}" class="party-checkbox h-4 w-4 rounded">
                    <label for="party-${p}" class="ml-2">${p}</label>
                </div>
            `;
        });
        container.classList.remove('hidden');
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏–π: ${e.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

function applyPartyFilter() {
    fetchAndRenderOrders();
    document.getElementById('party-filter-container').classList.add('hidden');
}

function toggleStatusFilter() {
    const container = document.getElementById('status-filter-container');
    const listDiv = document.getElementById('status-list');
    listDiv.innerHTML = '';
    orderStatuses.forEach(s => {
        listDiv.innerHTML += `
            <div>
                <input type="checkbox" id="status-${s}" value="${s}" class="status-checkbox h-4 w-4 rounded">
                <label for="status-${s}" class="ml-2">${s}</label>
            </div>
        `;
    });
    container.classList.toggle('hidden');
}

function applyAllFilters() {
    fetchAndRenderOrders();
    document.getElementById('party-filter-container').classList.add('hidden');
    document.getElementById('status-filter-container').classList.add('hidden');
}

function handleOrderCheckboxChange(e) {
    if (e.target.classList.contains('order-checkbox')) {
        const bar = document.getElementById('bulk-action-bar');
        const selected = document.querySelectorAll('.order-checkbox:checked');

        if (selected.length > 0) {
            bar.classList.remove('hidden');
            document.getElementById('selected-count').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selected.length}`;

            const selectedOrders = Array.from(selected).map(cb => orders.find(o => o.id == cb.dataset.orderId));
            const allAwaitingBuyout = selectedOrders.every(o => o.status === '–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞');

            const buyoutBtn = document.getElementById('bulk-buyout-btn');
            const statusBlock = document.getElementById('bulk-status-select').parentElement;
            const dateBlock = document.getElementById('bulk-party-date-input').parentElement;

            if (allAwaitingBuyout) {
                buyoutBtn.classList.remove('hidden');
                statusBlock.classList.add('hidden');
                dateBlock.classList.add('hidden');
            } else {
                buyoutBtn.classList.add('hidden');
                statusBlock.classList.remove('hidden');
                dateBlock.classList.remove('hidden');
                const statusSelect = document.getElementById('bulk-status-select');
                if (orderStatuses && orderStatuses.length > 0) {
                    statusSelect.innerHTML = orderStatuses.map(s => `<option value="${s}">${s}</option>`).join('');
                }
            }
        } else {
            bar.classList.add('hidden');
        }
    }
}

function handleSelectAllOrders(e) {
    document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = e.target.checked);
    handleOrderCheckboxChange({ target: { classList: { contains: () => true } } });
}

async function handleBulkUpdateStatus() {
    const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));
    const nS = document.getElementById('bulk-status-select').value;
    if (ids.length === 0) return alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã.');
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/bulk_action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update_status', order_ids: ids, new_status: nS })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(j.message);
        await fetchAllOrdersData();
        await fetchAndRenderOrders();
        toggleSelectMode();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞: ${e.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleBulkUpdatePartyDate() {
    const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));
    const newDate = document.getElementById('bulk-party-date-input').value;
    if (ids.length === 0) return alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã.');
    if (!newDate) return alert('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –ø–∞—Ä—Ç–∏–∏.');
    const pass = prompt(`–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –ø–∞—Ä—Ç–∏–∏ –¥–ª—è ${ids.length} –∑–∞–∫–∞–∑–æ–≤? –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:`);
    if (pass === null) return;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/bulk_action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update_party_date', order_ids: ids, new_party_date: newDate, password: pass })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(j.message);
        await fetchAndRenderOrders();
        toggleSelectMode();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞: ${e.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleBulkDelete() {
    const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));
    if (ids.length === 0) return alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã.');
    const p = prompt(`–£–¥–∞–ª–∏—Ç—å ${ids.length} –∑–∞–∫–∞–∑–æ–≤? –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:`);
    if (p === null) return;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/bulk_action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', order_ids: ids, password: p })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(j.message);
        await fetchAllOrdersData();
        await fetchAndRenderOrders();
        toggleSelectMode();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞: ${e.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function handleOrderExcelImport() {
    const i = document.getElementById('order-excel-input');
    const rDiv = document.getElementById('order-import-results');
    const partyDate = document.getElementById('import-party-date').value;

    if (i.files.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª.');
        return;
    }

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const json = await readExcelFile(i.files[0]);

        if (json.length === 0 || !json[0].track_code || (!json[0].client_code && !json[0].phone)) {
            alert('–û—à–∏–±–∫–∞! –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É "track_code" –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∏–∑ –∫–æ–ª–æ–Ω–æ–∫: "client_code" –∏–ª–∏ "phone".');
            return;
        }

        rDiv.innerHTML = `<p class="text-blue-600">–ò–¥–µ—Ç –∏–º–ø–æ—Ä—Ç ${json.length} –∑–∞–∫–∞–∑–æ–≤...</p>`;

        const payload = {
            orders_data: json.map(row => ({
                track_code: String(row.track_code),
                client_code: row.client_code ? String(row.client_code) : null,
                phone: row.phone ? String(row.phone) : null,
                comment: row.comment ? String(row.comment) : null
            })),
            party_date: partyDate ? partyDate : null
        };

        const res = await fetch(`${API_URL}/orders/bulk_import`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(await handleApiError(res));

        const j = await res.json();
        let msg = `<p class="text-green-600"><strong>–£—Å–ø–µ—à–Ω–æ: ${j.created_orders}</strong></p>`;
        if(j.warnings && j.warnings.length > 0) {
            msg += `<p class="text-yellow-600 mt-2"><strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (${j.warnings.length}):</strong></p><ul class="list-disc list-inside">${j.warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
        }
        if (j.errors && j.errors.length > 0) {
            msg += `<p class="text-red-600 mt-2"><strong>–û—à–∏–±–∫–∏ (${j.errors.length}):</strong></p><ul class="list-disc list-inside">${j.errors.map(er => `<li>${er}</li>`).join('')}</ul>`;
        }
        rDiv.innerHTML = msg;

        await fetchAllOrdersData();
        await fetchAndRenderOrders();

    } catch (err) {
        rDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${err.message}</p>`;
        console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–∫–∞–∑–æ–≤:", err);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function searchClients(q, onSelectCallback, resultsDiv) {
    if (!q) {
        resultsDiv.innerHTML = '';
        return;
    }
    // –ó–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä, —Ç.–∫. —ç—Ç–æ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    try {
        const r = await fetch(`${API_URL}/clients/search?q=${q}`);
        const fClients = await r.json();
        resultsDiv.innerHTML = '';
        if (fClients.length > 0) {
            fClients.forEach(c => {
                const i = document.createElement('div');
                i.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                i.textContent = `${c.full_name} (${c.client_code_prefix}${c.client_code_num}) - ${c.phone}`;
                i.addEventListener('click', () => onSelectCallback(c));
                resultsDiv.appendChild(i);
            });
        } else {
            resultsDiv.innerHTML = '<div class="p-2 text-gray-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", e);
    }
}

async function openEditOrderModal(orderId) {
    const modal = document.getElementById('edit-order-modal');
    const order = orders.find(o => o.id == orderId);
    if (!order) return alert('–û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.');

    let buyoutHtml = '';
    if (order.purchase_type === '–í—ã–∫—É–ø') {
        buyoutHtml = `
            <div>
                <label class="block text-sm">–†–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤—ã–∫—É–ø–∞ (—Å–æ–º/—é–∞–Ω—å)</label>
                <input type="number" step="any" name="buyout_actual_rate" class="mt-1 w-full p-2 border rounded" value="${order.buyout_actual_rate || ''}">
            </div>
        `;
    }

    modal.querySelector('.relative').innerHTML = `
        <div class="flex justify-between items-start">
            <h3 class="text-2xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑</h3>
            <button onclick="document.getElementById('edit-order-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
        </div>
        <form id="edit-order-form" data-order-id="${orderId}" class="space-y-4">
            <div>
                <label class="block text-sm">–¢—Ä–µ–∫-–∫–æ–¥</label>
                <input type="text" name="track_code" class="mt-1 w-full p-2 border rounded" value="${order.track_code}">
            </div>
            ${buyoutHtml}
            <div class="border-t pt-4 mt-4">
                <label class="block text-sm font-medium mb-2">–°–º–µ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</label>
                <div class="relative">
                    <input type="text" id="edit-order-client-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." class="w-full p-2 border rounded">
                    <input type="hidden" id="edit-order-new-client-id">
                    <div id="edit-order-client-results" class="absolute bottom-full left-0 right-0 bg-white border mb-1 rounded-md shadow-lg z-20"></div>
                </div>
            </div>
            <div class="flex gap-4 pt-4">
                <button type="button" onclick="document.getElementById('edit-order-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;
    modal.classList.add('is-open');

    document.getElementById('edit-order-client-search').addEventListener('input', (e) => {
        const resultsDiv = document.getElementById('edit-order-client-results');
        searchClients(e.target.value, (client) => {
            document.getElementById('edit-order-client-search').value = `${client.full_name} (${client.phone})`;
            document.getElementById('edit-order-new-client-id').value = client.id;
            resultsDiv.innerHTML = '';
        }, resultsDiv);
    });

    document.getElementById('edit-order-form').addEventListener('submit', handleSaveOrder);
}

async function handleSaveOrder(e) {
    e.preventDefault();
    const form = e.target;
    const orderId = form.dataset.orderId;
    const payload = {
        track_code: form.elements.track_code.value
    };

    if (form.elements.buyout_actual_rate) {
        payload.buyout_actual_rate = parseFloat(form.elements.buyout_actual_rate.value) || null;
    }

    const newClientId = document.getElementById('edit-order-new-client-id').value;
    if (newClientId) {
        payload.client_id = parseInt(newClientId);
    }

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/orders/${orderId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        document.getElementById('edit-order-modal').classList.remove('is-open');
        await fetchAndRenderOrders();
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

function handleExportOrders() {
    if (!orders || orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –∑–∞–∫–∞–∑—ã.');
        return;
    }

    alert(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É ${orders.length} –∑–∞–∫–∞–∑–æ–≤...`);

    const dataToExport = orders.map(order => {
        return {
            '–î–∞—Ç–∞ –ü–∞—Ä—Ç–∏–∏': order.party_date,
            '–¢—Ä–µ–∫-–∫–æ–¥': order.track_code,
            '–°—Ç–∞—Ç—É—Å': order.status,
            '–ö–ª–∏–µ–Ω—Ç': order.client.full_name,
            '–¢–µ–ª–µ—Ñ–æ–Ω –ö–ª–∏–µ–Ω—Ç–∞': order.client.phone,
            '–ö–æ–¥ –ö–ª–∏–µ–Ω—Ç–∞': `${order.client.client_code_prefix || ''}${order.client.client_code_num || ''}`,
            '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ': order.comment || '',
            '–î–∞—Ç–∞ –í—ã–¥–∞—á–∏': order.issued_at ? new Date(order.issued_at).toLocaleString() : '',
            '–í–µ—Å (–∫–≥)': order.weight_kg || '',
            '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Å–æ–º)': order.final_cost_som || ''
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '–ó–∞–∫–∞–∑—ã');
    XLSX.writeFile(workbook, `–≠–∫—Å–ø–æ—Ä—Ç_–ó–∞–∫–∞–∑–æ–≤_${new Date().toLocaleDateString()}.xlsx`);
}

function openWhatsAppModal(clientId) {
    const modal = document.getElementById('whatsapp-modal');
    const modalContent = modal.querySelector('.relative');
    const client = clients.find(c => c.id == clientId);
    if (!client) return alert('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.');

    const clientOrders = orders.filter(o => o.client_id == clientId && o.status !== '–í—ã–¥–∞–Ω');

    const ordersHtml = clientOrders.map(order => `
        <div class="flex items-center">
            <input type="checkbox" id="wa-order-${order.id}" value="${order.track_code}" class="wa-order-checkbox h-4 w-4" checked>
            <label for="wa-order-${order.id}" class="ml-3 block text-sm text-gray-900">${order.track_code} (${order.status})</label>
        </div>
    `).join('');

    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</h3>
            <button onclick="document.getElementById('whatsapp-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
        </div>
        <p class="mb-2 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</p>
        <div class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-md mb-4">${ordersHtml}</div>
        <label class="block text-sm font-medium">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
        <textarea id="whatsapp-message" class="w-full h-32 p-2 border rounded-md mt-1"></textarea>
        <div class="flex gap-4 mt-6">
            <button type="button" onclick="document.getElementById('whatsapp-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
            <button id="send-whatsapp-btn" class="w-full bg-green-500 text-white py-2 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    `;
    modal.classList.add('is-open');

    const generateMessage = () => {
        const checkedOrders = Array.from(document.querySelectorAll('.wa-order-checkbox:checked')).map(cb => cb.value);
        let message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${client.full_name}! üëã\n\n`;
        if (checkedOrders.length > 0) {
            message += `–•–æ—Ç–∏–º —É–≤–µ–¥–æ–º–∏—Ç—å –≤–∞—Å –æ –≤–∞—à–∏—Ö –∑–∞–∫–∞–∑–∞—Ö:\n\n`;
            checkedOrders.forEach(trackCode => {
                const order = orders.find(o => o.track_code === trackCode);
                message += `üì¶ –¢—Ä–µ–∫: ${order.track_code}\n–°—Ç–∞—Ç—É—Å: ${order.status}\n\n`;
            });
        } else {
            message += `–ï—Å—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –≤–∞—à–∏–º –∑–∞–∫–∞–∑–∞–º.`;
        }
        document.getElementById('whatsapp-message').value = message;
    };

    generateMessage();
    modal.querySelectorAll('.wa-order-checkbox').forEach(cb => cb.addEventListener('change', generateMessage));

    document.getElementById('send-whatsapp-btn').addEventListener('click', () => {
        const phone = client.phone.replace(/[^0-9]/g, '');
        const text = encodeURIComponent(document.getElementById('whatsapp-message').value);
        window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
        modal.classList.remove('is-open');
    });
}

function openBuyoutModal() {
    const modal = document.getElementById('buyout-modal');
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedOrders = Array.from(selectedCheckboxes).map(cb => orders.find(o => o.id == cb.dataset.orderId));

    const ordersHtml = selectedOrders.map(o => `<li class="text-sm">${o.track_code}</li>`).join('');

    modal.querySelector('.relative').innerHTML = `
        <h3 class="text-2xl font-bold mb-4">–ú–∞—Å—Å–æ–≤—ã–π –≤—ã–∫—É–ø</h3>
        <p class="text-sm mb-2">–í—ã–±—Ä–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–∫–∞–∑—ã:</p>
        <ul class="list-disc list-inside mb-4 max-h-40 overflow-y-auto">${ordersHtml}</ul>
        <form id="buyout-form">
            <div>
                <label class="block text-sm">–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤—ã–∫—É–ø–∞ (—Å–æ–º/—é–∞–Ω—å)</label>
                <input type="number" step="any" id="buyout-actual-rate-input" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div class="flex gap-4 mt-6">
                <button type="button" onclick="document.getElementById('buyout-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–∫—É–ø</button>
            </div>
        </form>
    `;
    modal.classList.add('is-open');
    document.getElementById('buyout-form').addEventListener('submit', handleBulkBuyout);
}

async function handleBulkBuyout(e) {
    e.preventDefault();
    const rate = parseFloat(document.getElementById('buyout-actual-rate-input').value);
    const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders/bulk_action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'buyout', order_ids: ids, buyout_actual_rate: rate })
        });
        if (!r.ok) throw new Error(await handleApiError(r));
        const j = await r.json();
        alert(j.message);
        document.getElementById('buyout-modal').classList.remove('is-open');
        await fetchAndRenderOrders();
        toggleSelectMode();
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –í–´–î–ê–ß–ê
// =================================================================

const renderIssueTab = () => {
    const pane = document.getElementById('tab-issue');
    if (!pane) return;
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">–ó–∞–∫–∞–∑—ã, –≥–æ—Ç–æ–≤—ã–µ –∫ –≤—ã–¥–∞—á–µ</h2>
                <div>
                    <button id="show-issued-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞–Ω–Ω—ã—Ö</button>
                    <button id="refresh-issue-list" title="–û–±–Ω–æ–≤–∏—Ç—å" class="text-2xl ml-4">&circlearrowright;</button>
                </div>
            </div>
            <div class="mb-4">
                <input type="search" id="issue-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç–µ–ª–µ—Ñ–æ–Ω—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="issue-list" class="space-y-4"></div>
        </div>
    `;
    document.getElementById('refresh-issue-list').addEventListener('click', fetchAndRenderIssueList);
    document.getElementById('show-issued-history-btn').addEventListener('click', showIssuedHistory);
    document.getElementById('issue-search-input').addEventListener('input', handleIssueSearch);

    pane.addEventListener('click', (e) => {
        if (e.target.classList.contains('issue-btn')) {
            const clientId = e.target.dataset.clientId;
            const client = clients.find(c => c.id == clientId);

            const selectedCheckboxes = document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]:checked`);
            const orderIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.orderId));

            if (orderIds.length === 0) return;

            if (!client.client_code_num || client.full_name.toLowerCase().includes('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')) {
                promptToUpdateClientData(client, () => renderIssueModal(orderIds));
            } else {
                renderIssueModal(orderIds);
            }
        }
    });

    pane.addEventListener('change', (e) => {
        const target = e.target;
        if (target.classList.contains('select-all-client-orders')) {
            const clientId = target.dataset.clientId;
            const orderCheckboxes = document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]`);
            orderCheckboxes.forEach(cb => cb.checked = target.checked);
        }
        if (target.classList.contains('issue-order-checkbox') || target.classList.contains('select-all-client-orders')) {
            const clientId = target.dataset.clientId;
            const issueBtn = document.querySelector(`.issue-btn[data-client-id="${clientId}"]`);
            const anyChecked = document.querySelector(`.issue-order-checkbox[data-client-id="${clientId}"]:checked`);
            issueBtn.disabled = !anyChecked;
        }
    });
};

function handleIssueSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    const clientGroups = document.querySelectorAll('#issue-list .client-group');
    clientGroups.forEach(group => {
        const clientName = group.dataset.clientName.toLowerCase();
        const clientCode = group.dataset.clientCode.toLowerCase();
        const clientPhone = group.dataset.clientPhone.toLowerCase();
        const trackCodes = group.dataset.trackCodes.toLowerCase();

        if (clientName.includes(searchTerm) || clientCode.includes(searchTerm) || clientPhone.includes(searchTerm) || trackCodes.includes(searchTerm)) {
            group.classList.remove('hidden');
        } else {
            group.classList.add('hidden');
        }
    });
}

async function fetchAndRenderIssueList() {
    const listDiv = document.getElementById('issue-list');
    listDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏...</p>';
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/orders/ready_for_issue`);
        if (!response.ok) throw new Error(await handleApiError(response));
        const data = await response.json();
        const ordersByClient = data.orders.reduce((acc, order) => {
            const client_id = order.client.id;
            if (!acc[client_id]) {
                acc[client_id] = { client: order.client, orders: [] };
            }
            acc[client_id].orders.push(order);
            return acc;
        }, {});

        listDiv.innerHTML = '';
        if (Object.keys(ordersByClient).length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤, –≥–æ—Ç–æ–≤—ã—Ö –∫ –≤—ã–¥–∞—á–µ.</p>';
            return;
        }

        for (const clientId in ordersByClient) {
            const group = ordersByClient[clientId];
            const clientDiv = document.createElement('div');
            clientDiv.className = 'client-group p-4 bg-gray-50 rounded-lg shadow-sm';
            clientDiv.dataset.clientName = group.client.full_name;
            clientDiv.dataset.clientCode = `${group.client.client_code_prefix}${group.client.client_code_num}`;
            clientDiv.dataset.clientPhone = group.client.phone;
            clientDiv.dataset.trackCodes = group.orders.map(o => o.track_code).join(',');

            const ordersHtml = group.orders.map(o => `
                <li class="flex items-center gap-2">
                    <input type="checkbox" class="issue-order-checkbox h-4 w-4" data-order-id="${o.id}" data-client-id="${clientId}">
                    <span>${o.track_code}</span>
                </li>
            `).join('');

            clientDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="select-all-client-orders h-5 w-5" data-client-id="${clientId}" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞">
                        <div>
                            <h3 class="font-bold text-lg">${group.client.full_name}</h3>
                            <p class="text-sm text-gray-600">${group.client.client_code_prefix}${group.client.client_code_num}</p>
                        </div>
                    </div>
                    <button class="issue-btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg" data-client-id="${clientId}" disabled>–í—ã–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                </div>
                <ul class="mt-2 space-y-1 pl-8">${ordersHtml}</ul>
            `;
            listDiv.appendChild(clientDiv);
        }
    } catch (error) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function renderIssueModal(orderIds) {
    if (!activeShift) {
        alert('–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞! –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É, —á—Ç–æ–±—ã –≤—ã–¥–∞—Ç—å –∑–∞–∫–∞–∑.');
        return;
    }
    const issueModal = document.getElementById('issue-modal');
    const modalContent = issueModal.querySelector('.relative');
    const ordersToIssue = orders.filter(o => orderIds.includes(o.id));
    let ordersHtml = ordersToIssue.map(o => `
        <div class="flex justify-between items-center border-b pb-2 mb-2">
            <span class="font-semibold text-sm">${o.track_code}</span>
            <input type="number" step="any" placeholder="–í–µ—Å (–∫–≥)" class="issue-weight-input w-24 p-1 border rounded text-sm" data-order-id="${o.id}" required>
        </div>
    `).join('');

    modalContent.innerHTML = `
        <h3 class="text-2xl font-bold mb-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏</h3>
        <form id="issue-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <label class="block text-sm font-medium">–û–±—â–∏–π –≤–µ—Å (–∫–≥)</label>
                        <input type="number" step="any" id="total-weight-input" placeholder="–î–ª—è –∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div class="max-h-60 overflow-y-auto pr-2">${ordersHtml}</div>
                    <div class="p-3 bg-gray-100 rounded-lg space-y-2">
                        <div>
                            <label class="block text-sm">–¶–µ–Ω–∞ –∑–∞ –∫–≥ ($)</label>
                            <input type="number" step="0.1" id="issue-price-per-kg" value="${sysConfig.price_per_kg_usd}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm">–ö—É—Ä—Å USD (—Å–æ–º)</label>
                            <input type="number" step="0.1" id="issue-exchange-rate" value="${sysConfig.exchange_rate_usd}" class="w-full p-2 border rounded">
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                        <select id="payment-method-select" class="w-full mt-1 p-2 border rounded-md bg-white">
                            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                            <option value="card">–ö–∞—Ä—Ç–æ–π</option>
                            <option value="mixed">–°–º–µ—à–∞–Ω–Ω—ã–π</option>
                        </select>
                    </div>
                    <div id="payment-fields-container" class="space-y-3"></div>
                    <div class="p-4 bg-indigo-50 rounded-lg text-right space-y-2">
                        <div class="text-lg">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <span id="total-cost-display" class="font-bold">0.00 —Å–æ–º</span></div>
                        <div class="text-md">–í—Å–µ–≥–æ –æ–ø–ª–∞—á–µ–Ω–æ: <span id="total-paid-display" class="font-bold">0.00 —Å–æ–º</span></div>
                        <div class="text-xl text-green-600">–°–¥–∞—á–∞: <span id="change-display" class="font-bold">0.00 —Å–æ–º</span></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button type="button" id="cancel-issue" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">–í—ã–¥–∞—Ç—å</button>
            </div>
        </form>
    `;
    issueModal.classList.add('is-open');

    const form = modalContent.querySelector('#issue-form');
    const paymentMethodSelect = document.getElementById('payment-method-select');
    const paymentFieldsContainer = document.getElementById('payment-fields-container');
    const totalWeightInput = document.getElementById('total-weight-input');
    const individualWeightInputs = document.querySelectorAll('.issue-weight-input');
    const priceInput = document.getElementById('issue-price-per-kg');
    const rateInput = document.getElementById('issue-exchange-rate');
    let totalCost = 0;

    const updateTotals = () => {
        const price = parseFloat(priceInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        let totalWeight = 0;
        individualWeightInputs.forEach(input => { totalWeight += parseFloat(input.value) || 0; });
        totalCost = totalWeight * price * rate;
        document.getElementById('total-cost-display').textContent = `${totalCost.toFixed(2)} —Å–æ–º`;
        updatePaymentFields();
    };

    const updatePaymentFields = () => {
        const method = paymentMethodSelect.value;
        let cashPaid = parseFloat(document.getElementById('issue-paid-cash')?.value) || 0;
        let cardPaid = parseFloat(document.getElementById('issue-paid-card')?.value) || 0;
        if (method === 'card') {
            cardPaid = totalCost;
            cashPaid = 0;
        }
        let totalPaid = cashPaid + cardPaid;
        let change = totalPaid > totalCost ? totalPaid - totalCost : 0;
        document.getElementById('total-paid-display').textContent = `${totalPaid.toFixed(2)} —Å–æ–º`;
        document.getElementById('change-display').textContent = `${change.toFixed(2)} —Å–æ–º`;
        if (document.getElementById('issue-paid-card') && method === 'card') {
            document.getElementById('issue-paid-card').value = cardPaid.toFixed(2);
        }
    };

    const renderPaymentFields = () => {
        const method = paymentMethodSelect.value;
        paymentFieldsContainer.innerHTML = '';
        const cashField = `<div><label class="block text-sm">–ù–∞–ª–∏—á–Ω—ã–º–∏ (—Å–æ–º)</label><input type="number" id="issue-paid-cash" value="0" class="w-full p-2 border rounded"></div>`;
        const cardField = `<div><label class="block text-sm">–ö–∞—Ä—Ç–æ–π (—Å–æ–º)</label><input type="number" id="issue-paid-card" value="0.00" class="w-full p-2 border rounded" ${method === 'card' ? 'readonly' : ''}></div>`;
        const cardType = `<div><label class="block text-sm">–¢–∏–ø –∫–∞—Ä—Ç—ã</label><select id="issue-card-type" class="w-full p-2 border rounded bg-white">${sysConfig.card_payment_types.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>`;

        if (method === 'cash') paymentFieldsContainer.innerHTML = cashField;
        if (method === 'card') paymentFieldsContainer.innerHTML = cardField + cardType;
        if (method === 'mixed') paymentFieldsContainer.innerHTML = cashField + cardField + cardType;

        document.getElementById('issue-paid-cash')?.addEventListener('input', () => {
            if (method === 'mixed') {
                const cashAmount = parseFloat(document.getElementById('issue-paid-cash').value) || 0;
                const remainder = totalCost - cashAmount;
                document.getElementById('issue-paid-card').value = (remainder > 0 ? remainder : 0).toFixed(2);
            }
            updatePaymentFields();
        });
        document.getElementById('issue-paid-card')?.addEventListener('input', updatePaymentFields);
        updateTotals();
    };

    renderPaymentFields();
    paymentMethodSelect.addEventListener('change', renderPaymentFields);
    [priceInput, rateInput].forEach(el => el.addEventListener('input', updateTotals));
    totalWeightInput.addEventListener('input', () => {
        const totalWeight = parseFloat(totalWeightInput.value) || 0;
        if (totalWeight >= 0 && individualWeightInputs.length > 0) {
            const weightPerItem = (totalWeight / individualWeightInputs.length).toFixed(3);
            individualWeightInputs.forEach(input => { input.value = weightPerItem; });
        } else { individualWeightInputs.forEach(input => { input.value = ''; }); }
        updateTotals();
    });
    individualWeightInputs.forEach(input => {
        input.addEventListener('input', () => {
            totalWeightInput.value = '';
            updateTotals();
        });
    });
    document.getElementById('cancel-issue').addEventListener('click', () => issueModal.classList.remove('is-open'));
    form.addEventListener('submit', handleIssueSubmit);
}

async function handleIssueSubmit(e) {
    e.preventDefault();
    const ordersPayload = Array.from(document.querySelectorAll('.issue-weight-input')).map(input => ({
        order_id: parseInt(input.dataset.orderId),
        weight_kg: parseFloat(input.value)
    }));
    if (ordersPayload.some(o => !o.weight_kg || o.weight_kg <= 0)) {
        alert('–û—à–∏–±–∫–∞: –≤–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –∏ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.');
        return;
    }
    const method = document.getElementById('payment-method-select').value;
    const payload = {
        orders: ordersPayload,
        price_per_kg_usd: parseFloat(document.getElementById('issue-price-per-kg').value),
        exchange_rate_usd: parseFloat(document.getElementById('issue-exchange-rate').value),
        paid_cash: (method === 'cash' || method === 'mixed') ? (parseFloat(document.getElementById('issue-paid-cash').value) || 0) : 0,
        paid_card: (method === 'card' || method === 'mixed') ? (parseFloat(document.getElementById('issue-paid-card').value) || 0) : 0,
        card_payment_type: (method === 'card' || method === 'mixed') ? document.getElementById('issue-card-type').value : null
    };

    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/orders/issue`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(await handleApiError(response));
        const result = await response.json();
        alert(result.message);
        issueModal.classList.remove('is-open');
        await fetchAndRenderIssueList();
        await fetchAllOrdersData();
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ: ${error.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function showIssuedHistory() {
    const issuedHistoryModal = document.getElementById('issued-history-modal');
    const modalContent = issuedHistoryModal.querySelector('.relative');

    const today = new Date().toISOString().split('T')[0];
    modalContent.innerHTML = `
        <div class="flex justify-between items-center mb-4">
             <h3 class="text-2xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h3>
             <button id="close-history-modal-btn" class="text-2xl font-bold">&times;</button>
        </div>
        <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4">
            <div>
                <label for="history-start-date" class="block text-sm font-medium">–°</label>
                <input type="date" id="history-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
            </div>
            <div>
                <label for="history-end-date" class="block text-sm font-medium">–ü–æ</label>
                <input type="date" id="history-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
            </div>
            <button id="filter-history-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div id="history-content" class="overflow-y-auto max-h-[60vh]">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    `;
    issuedHistoryModal.classList.add('is-open');

    const fetchAndRenderHistory = async () => {
        const contentDiv = document.getElementById('history-content');
        contentDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
        const startDate = document.getElementById('history-start-date').value;
        const endDate = document.getElementById('history-end-date').value;
        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

        try {
            const response = await fetch(`${API_URL}/orders/issued?start_date=${startDate}&end_date=${endDate}`);
            if (!response.ok) throw new Error(await handleApiError(response));
            const data = await response.json();

            if (!data.orders || data.orders.length === 0) {
                contentDiv.innerHTML = '<p class="text-gray-500">–í—ã–¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç.</p>';
                return;
            }

            const tableRows = data.orders.map(o => `
                <tr class="border-b hover:bg-gray-50 text-sm">
                    <td class="p-2"><input type="checkbox" class="history-checkbox h-4 w-4" data-order-id="${o.id}"></td>
                    <td class="p-2">${new Date(o.issued_at).toLocaleString()}</td>
                    <td class="p-2">${o.client.full_name} (${o.client.client_code_prefix}${o.client.client_code_num})</td>
                    <td class="p-2">${o.track_code}</td>
                    <td class="p-2">${o.final_cost_som.toFixed(2)} —Å–æ–º</td>
                    <td class="p-2">
                        <button class="revert-status-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 px-2 py-1 rounded" data-order-id="${o.id}">–í–µ—Ä–Ω—É—Ç—å</button>
                    </td>
                </tr>
            `).join('');

            contentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4 gap-4">
                    <input type="search" id="history-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
                    <button id="bulk-revert-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg whitespace-nowrap">–í–µ—Ä–Ω—É—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                </div>
                <div class="overflow-y-auto max-h-[50vh]">
                    <table class="w-full text-left" id="history-table">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                               <th class="p-2"><input type="checkbox" id="select-all-history" class="h-4 w-4"></th>
                               <th class="p-2">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                               <th class="p-2">–ö–ª–∏–µ–Ω—Ç</th>
                               <th class="p-2">–¢—Ä–µ–∫-–∫–æ–¥</th>
                               <th class="p-2">–°—É–º–º–∞</th>
                               <th class="p-2">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;

            document.getElementById('history-search-input').addEventListener('input', handleHistorySearch);
            document.getElementById('bulk-revert-btn').addEventListener('click', handleBulkRevert);

            document.getElementById('select-all-history').addEventListener('change', (e) => {
                document.querySelectorAll('.history-checkbox').forEach(cb => cb.checked = e.target.checked);
            });

            contentDiv.querySelector('table').addEventListener('click', e => {
                if (e.target.classList.contains('revert-status-btn')) {
                    const orderId = e.target.dataset.orderId;
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                        revertOrderStatus(orderId);
                    }
                }
            });

        } catch (error) {
            contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${error.message}</p>`;
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    };

    document.getElementById('close-history-modal-btn').addEventListener('click', () => issuedHistoryModal.classList.remove('is-open'));
    document.getElementById('filter-history-btn').addEventListener('click', fetchAndRenderHistory);

    fetchAndRenderHistory();
}

async function revertOrderStatus(orderId) {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const response = await fetch(`${API_URL}/orders/${orderId}/revert_status`, { method: 'PATCH' });
        if (!response.ok) throw new Error(await handleApiError(response));
        alert('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω!');
        await showIssuedHistory();
        await fetchAndRenderIssueList();
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function fetchAllOrdersData() {
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    try {
        const r = await fetch(`${API_URL}/orders`);
        if (!r.ok) throw new Error('Failed to fetch orders data');
        const j = await r.json();
        orders = j.orders;
    } catch(e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –∑–∞–∫–∞–∑–∞–º:", e);
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –§–£–ù–ö–¶–ò–ò-–ü–û–ú–û–©–ù–ò–ö–ò
// =================================================================

function promptToUpdateClientData(client, onSuccessCallback) {
    const editClientModal = document.getElementById('edit-client-modal');
    const modalContent = editClientModal.querySelector('.relative');

    alert('–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π.');

    modalContent.innerHTML = `
        <h3 class="text-2xl font-bold mb-4">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
        <form id="force-edit-client-form" class="space-y-4">
            <div>
                <label class="block text-sm">–§–ò–û</label>
                <input type="text" id="force-edit-full_name" value="${client.full_name}" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div>
                <label class="block text-sm">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="force-edit-phone" value="${client.phone}" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-sm">–ü—Ä–µ—Ñ–∏–∫—Å</label>
                    <input type="text" id="force-edit-prefix" value="${client.client_code_prefix || 'KB'}" class="mt-1 w-full p-2 border rounded" required>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm">–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="number" id="force-edit-code" value="${client.client_code_num || ''}" class="mt-1 w-full p-2 border rounded" required>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button type="button" onclick="document.getElementById('edit-client-modal').classList.remove('is-open')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </form>
    `;
    editClientModal.classList.add('is-open');

    document.getElementById('force-edit-client-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            full_name: document.getElementById('force-edit-full_name').value,
            phone: document.getElementById('force-edit-phone').value,
            client_code_prefix: document.getElementById('force-edit-prefix').value,
            client_code_num: parseInt(document.getElementById('force-edit-code').value)
        };

        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        try {
            const r = await fetch(`${API_URL}/clients/${client.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!r.ok) throw new Error(await handleApiError(r));

            alert('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
            editClientModal.classList.remove('is-open');

            await fetchAndRenderClients();
            await fetchAndRenderIssueList();

            if (onSuccessCallback) {
                onSuccessCallback();
            }
        } catch (err) {
            alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    });
}

function handleHistorySearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#history-table tbody tr').forEach(row => {
        const rowContent = row.textContent.toLowerCase();
        if (rowContent.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

async function handleBulkRevert() {
    const checked = document.querySelectorAll('.history-checkbox:checked');
    const orderIds = Array.from(checked).map(cb => parseInt(cb.dataset.orderId));

    if (orderIds.length === 0) {
        alert('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.');
        return;
    }

    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å ${orderIds.length} –∑–∞–∫–∞–∑(–æ–≤)?`)) {
        showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        try {
            const response = await fetch(`${API_URL}/orders/bulk_action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'revert', order_ids: orderIds })
            });
            if (!response.ok) throw new Error(await handleApiError(response));

            alert('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.');
            await showIssuedHistory();
            await fetchAndRenderIssueList();
        } catch (err) {
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ: ${err.message}`);
        } finally {
            hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
        }
    }
}

// =================================================================
// –§–£–ù–ö–¶–ò–ò –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –ü–û–ò–°–ö–ê –ü–û –í–ö–õ–ê–î–ö–ê–ú
// =================================================================

function handleOrdersSearch(e) {
    const searchTerm = e.target.value.toLowerCase();

    document.querySelectorAll('#orders-list > div').forEach(group => {
        const headerContent = group.querySelector('div').textContent.toLowerCase();
        const orderItems = group.querySelectorAll('ul > li');

        if (headerContent.includes(searchTerm)) {
            group.classList.remove('hidden');
            orderItems.forEach(li => li.classList.remove('hidden'));
            return;
        }

        let visibleOrdersCount = 0;
        orderItems.forEach(li => {
            const trackCodeContent = li.textContent.toLowerCase();
            if (trackCodeContent.includes(searchTerm)) {
                li.classList.remove('hidden');
                visibleOrdersCount++;
            } else {
                li.classList.add('hidden');
            }
        });

        if (visibleOrdersCount > 0) {
            group.classList.remove('hidden');
        } else {
            group.classList.add('hidden');
        }
    });
}

function handleClientsSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#clients-list > div').forEach(clientDiv => {
        const clientContent = clientDiv.textContent.toLowerCase();
        if (clientContent.includes(searchTerm)) {
            clientDiv.classList.remove('hidden');
        } else {
            clientDiv.classList.add('hidden');
        }
    });
}

function handleExpensesSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#expenses-list > div').forEach(expenseDiv => {
        const expenseContent = expenseDiv.textContent.toLowerCase();
        if (expenseContent.includes(searchTerm)) {
            expenseDiv.classList.remove('hidden');
        } else {
            expenseDiv.classList.add('hidden');
        }
    });
}

function handleBuyoutReportSearch(e) {
    const searchTerm = e.target.value.toLowerCase();
    let visibleProfit = 0;

    document.querySelectorAll('#buyout-report-content table tbody tr').forEach(row => {
        const rowContent = row.textContent.toLowerCase();
        if (rowContent.includes(searchTerm)) {
            row.style.display = '';
            const profitCell = row.querySelector('td:last-child');
            if (profitCell) {
                visibleProfit += parseFloat(profitCell.textContent) || 0;
            }
        } else {
            row.style.display = 'none';
        }
    });

    const totalProfitSpan = document.getElementById('buyout-total-profit');
    if (totalProfitSpan) {
        totalProfitSpan.textContent = `${visibleProfit.toFixed(2)} —Å–æ–º`;
        totalProfitSpan.classList.toggle('text-green-700', visibleProfit >= 0);
        totalProfitSpan.classList.toggle('text-red-700', visibleProfit < 0);
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –û–¢–ß–ï–¢ –ü–û –°–ú–ï–ù–ï
// =================================================================

function renderShiftReportTab() {
    const pane = document.getElementById('tab-report');
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 class="text-2xl font-bold">–û—Ç—á–µ—Ç –ø–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω–µ</h2>
                <button id="refresh-report-btn" title="–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç" class="text-2xl">&circlearrowright;</button>
            </div>
            <div id="report-content" class="space-y-3">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞...</p>
            </div>
        </div>
    `;
    document.getElementById('refresh-report-btn').addEventListener('click', fetchAndRenderShiftReport);
    fetchAndRenderShiftReport();
}

async function fetchAndRenderShiftReport() {
    const contentDiv = document.getElementById('report-content');
    contentDiv.innerHTML = '<p>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>';
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    try {
        const response = await fetch(`${API_URL}/shifts/report/current`);

        if (response.status === 404) {
            contentDiv.innerHTML = '<p class="text-red-500 font-semibold">–ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç—á–µ—Ç.</p>';
            return;
        }
        if (!response.ok) throw new Error(await handleApiError(response));

        const data = await response.json();
        const report = data.report;

        contentDiv.innerHTML = `
            <div class="text-sm text-gray-500">
                <p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> ${report.employee_name}</p>
                <p><strong>–°–º–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞:</strong> ${new Date(report.shift_start_time).toLocaleString()}</p>
            </div>
            <div class="border-t pt-4 mt-4 space-y-2 text-lg">
                <div class="flex justify-between"><span>–ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞ –Ω–∞—á–∞–ª–æ —Å–º–µ–Ω—ã:</span> <span class="font-semibold">${report.starting_cash.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-green-600"><span>–ü—Ä–∏—Ö–æ–¥ –Ω–∞–ª–∏—á–Ω—ã–º–∏ (+):</span> <span class="font-semibold">${report.cash_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-blue-600"><span>–ü—Ä–∏—Ö–æ–¥ –ø–æ –∫–∞—Ä—Ç–µ (+):</span> <span class="font-semibold">${report.card_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-red-600"><span>–†–∞—Å—Ö–æ–¥—ã (-):</span> <span class="font-semibold">${report.total_expenses.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-yellow-600"><span>–í–æ–∑–≤—Ä–∞—Ç—ã (-):</span> <span class="font-semibold">${report.total_returns.toFixed(2)} —Å–æ–º</span></div>
            </div>
            <div class="border-t pt-4 mt-4">
                <div class="flex justify-between text-xl font-bold">
                    <span>–ò—Ç–æ–≥–æ –≤ –∫–∞—Å—Å–µ (—Ä–∞—Å—á–µ—Ç):</span>
                    <span>${report.calculated_cash.toFixed(2)} —Å–æ–º</span>
                </div>
            </div>
        `;

    } catch (e) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –°–í–û–î–ù–´–ô –û–¢–ß–ï–¢
// =================================================================

function renderSummaryReportTab() {
    const pane = document.getElementById('tab-summary-report');
    const today = new Date().toISOString().split('T')[0];

    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4">
                <div>
                    <label for="summary-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="summary-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="summary-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="summary-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <button id="generate-summary-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div id="summary-report-content">
                <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç.</p>
            </div>
        </div>
    `;
    document.getElementById('generate-summary-report-btn').addEventListener('click', fetchAndRenderSummaryReport);
}

async function fetchAndRenderSummaryReport() {
    const contentDiv = document.getElementById('summary-report-content');
    contentDiv.innerHTML = '<p>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>';
    const startDate = document.getElementById('summary-start-date').value;
    const endDate = document.getElementById('summary-end-date').value;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    try {
        const response = await fetch(`${API_URL}/reports/summary?start_date=${startDate}&end_date=${endDate}`);
        if (!response.ok) throw new Error(await handleApiError(response));
        const data = await response.json();
        const summary = data.summary;

        let expensesHtml = Object.entries(summary.expenses_by_type)
            .map(([type, amount]) => `<div class="flex justify-between text-sm text-gray-700 ml-4"><span>- ${type}:</span><span>${amount.toFixed(2)} —Å–æ–º</span></div>`)
            .join('');
        if (!expensesHtml) {
            expensesHtml = '<p class="text-sm text-gray-500 ml-4">–†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç.</p>';
        }

        let shiftsHtml = '<h3 class="text-xl font-bold mt-6 mb-2">–°–º–µ–Ω—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>';
        if (!summary.shifts || summary.shifts.length === 0) {
            shiftsHtml += '<p class="text-gray-500">–°–º–µ–Ω –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        } else {
            shiftsHtml += summary.shifts.map(shift => `
                <div class="p-2 border rounded-md hover:bg-gray-50 flex justify-between items-center">
                    <div>
                        <p><strong>${shift.employee.full_name}</strong></p>
                        <p class="text-sm text-gray-500">${new Date(shift.start_time).toLocaleString()} - ${shift.end_time ? new Date(shift.end_time).toLocaleString() : '–ê–ö–¢–ò–í–ù–ê'}</p>
                    </div>
                    <button class="view-shift-report-btn bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full" data-shift-id="${shift.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                </div>
            `).join('');
        }

        contentDiv.innerHTML = `
            <div class="border-t pt-4 mt-4 space-y-3 text-lg">
                <div class="flex justify-between text-green-600"><span>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (+):</span><span class="font-bold">${summary.total_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-sm text-gray-700 ml-4"><span>(–ù–∞–ª–∏—á–Ω—ã–º–∏):</span><span>${summary.total_cash_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-sm text-gray-700 ml-4"><span>(–ö–∞—Ä—Ç–æ–π):</span><span>${summary.total_card_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-red-600 mt-4"><span>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (-):</span><span class="font-bold">${summary.total_expenses.toFixed(2)} —Å–æ–º</span></div>
                ${expensesHtml}
            </div>
            <div class="border-t pt-4 mt-6">
                <div class="flex justify-between text-2xl font-bold ${summary.net_profit >= 0 ? 'text-green-700' : 'text-red-700'}">
                    <span>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</span><span>${summary.net_profit.toFixed(2)} —Å–æ–º</span>
                </div>
            </div>
            ${shiftsHtml}
        `;

        document.querySelectorAll('.view-shift-report-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const shiftId = e.target.dataset.shiftId;
                showPastShiftReportModal(shiftId);
            });
        });
    } catch (e) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

async function showPastShiftReportModal(shiftId) {
    const modal = document.getElementById('shift-report-modal');
    const contentDiv = modal.querySelector('.relative');
    contentDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–º–µ–Ω–µ...</p>';
    modal.classList.add('is-open');
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    try {
        const response = await fetch(`${API_URL}/shifts/report/${shiftId}`);
        if (!response.ok) throw new Error(await handleApiError(response));
        const data = await response.json();
        const report = data.report;

        contentDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ ‚Ññ${report.shift_id}</h3>
                <button onclick="document.getElementById('shift-report-modal').classList.remove('is-open')" class="text-2xl font-bold">&times;</button>
            </div>
            <div class="text-sm text-gray-500">
                <p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> ${report.employee_name}</p>
                <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> ${new Date(report.shift_start_time).toLocaleString()} - ${report.shift_end_time ? new Date(report.shift_end_time).toLocaleString() : '–ê–ö–¢–ò–í–ù–ê'}</p>
            </div>
            <div class="border-t pt-4 mt-4 space-y-2 text-lg">
                <div class="flex justify-between"><span>–ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞ –Ω–∞—á–∞–ª–æ:</span> <span class="font-semibold">${report.starting_cash.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-green-600"><span>–ü—Ä–∏—Ö–æ–¥ –Ω–∞–ª–∏—á–Ω—ã–º–∏ (+):</span> <span class="font-semibold">${report.cash_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-red-600"><span>–†–∞—Å—Ö–æ–¥—ã (-):</span> <span class="font-semibold">${report.total_expenses.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-yellow-600"><span>–í–æ–∑–≤—Ä–∞—Ç—ã (-):</span> <span class="font-semibold">${report.total_returns.toFixed(2)} —Å–æ–º</span></div>
            </div>
            <div class="border-t pt-4 mt-4 space-y-2">
                <div class="flex justify-between text-xl font-bold"><span>–ò—Ç–æ–≥–æ –≤ –∫–∞—Å—Å–µ (—Ä–∞—Å—á–µ—Ç):</span><span>${report.calculated_cash.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-lg"><span>–í –∫–∞—Å—Å–µ –ø–æ —Ñ–∞–∫—Ç—É:</span><span class="font-semibold">${report.actual_closing_cash?.toFixed(2) || '–°–º–µ–Ω–∞ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞'} —Å–æ–º</span></div>
            </div>
        `;
    } catch (e) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –û–¢–ß–ï–¢ –ü–û –í–´–ö–£–ü–£
// =================================================================

function renderBuyoutReportTab() {
    const pane = document.getElementById('tab-buyout-report');
    const today = new Date().toISOString().split('T')[0];

    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø–∞–º –∏ –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü–µ</h2>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4">
                <div>
                    <label for="buyout-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="buyout-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="buyout-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="buyout-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <button id="generate-buyout-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="mb-4">
                <input type="search" id="buyout-report-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
            </div>
            <div id="buyout-report-content" class="overflow-x-auto">
                <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å".</p>
            </div>
        </div>
    `;
    document.getElementById('generate-buyout-report-btn').addEventListener('click', fetchAndRenderBuyoutReport);
    document.getElementById('buyout-report-search-input').addEventListener('input', handleBuyoutReportSearch);
}

async function fetchAndRenderBuyoutReport() {
    const contentDiv = document.getElementById('buyout-report-content');
    contentDiv.innerHTML = '<p>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>';
    const startDate = document.getElementById('buyout-start-date').value;
    const endDate = document.getElementById('buyout-end-date').value;
    showLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û

    try {
        const response = await fetch(`${API_URL}/reports/buyout?start_date=${startDate}&end_date=${endDate}`);
        if (!response.ok) throw new Error(await handleApiError(response));
        const data = await response.json();
        const { items, total_profit } = data.report;

        if (items.length === 0) {
            contentDiv.innerHTML = '<p class="text-gray-500">–ó–∞–∫–∞–∑–æ–≤ –Ω–∞ –≤—ã–∫—É–ø –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç.</p>';
            return;
        }

        const rowsHtml = items.map(item => `
            <tr class="border-b text-sm hover:bg-gray-50">
                <td class="p-2">${new Date(item.created_at).toLocaleDateString()}</td>
                <td class="p-2">${item.client_name}</td>
                <td class="p-2">${item.track_code}</td>
                <td class="p-2">${item.item_cost_cny?.toFixed(2) || '-'}</td>
                <td class="p-2">${item.rate_for_client?.toFixed(2) || '-'}</td>
                <td class="p-2 font-semibold">${item.price_for_client?.toFixed(2) || '-'}</td>
                <td class="p-2">${item.actual_rate?.toFixed(2) || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td class="p-2">${item.actual_cost?.toFixed(2) || '-'}</td>
                <td class="p-2 font-bold ${item.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${item.profit?.toFixed(2) || '0.00'}</td>
            </tr>
        `).join('');

        contentDiv.innerHTML = `
            <table class="w-full min-w-[900px]">
                <thead class="bg-gray-100">
                    <tr class="text-left text-xs font-bold uppercase">
                        <th class="p-2">–î–∞—Ç–∞</th>
                        <th class="p-2">–ö–ª–∏–µ–Ω—Ç</th>
                        <th class="p-2">–¢—Ä–µ–∫</th>
                        <th class="p-2">–¶–µ–Ω–∞(CNY)</th>
                        <th class="p-2">–ö—É—Ä—Å(–∫–ª–∏–µ–Ω—Ç)</th>
                        <th class="p-2">–¶–µ–Ω–∞(–∫–ª–∏–µ–Ω—Ç)</th>
                        <th class="p-2">–†–µ–∞–ª. –∫—É—Ä—Å</th>
                        <th class="p-2">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th class="p-2">–ü—Ä–∏–±—ã–ª—å</th>
                    </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            <div class="mt-4 text-right">
                <span class="text-lg font-bold">–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –æ—Ç –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü—ã:</span>
                <span id="buyout-total-profit" class="text-xl font-bold ${total_profit >= 0 ? 'text-green-700' : 'text-red-700'}">${total_profit.toFixed(2)} —Å–æ–º</span>
            </div>
        `;
    } catch (e) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${e.message}</p>`;
    } finally {
        hideLoader(); // <--- –î–û–ë–ê–í–õ–ï–ù–û
    }
}

</script>
</body>
</html>